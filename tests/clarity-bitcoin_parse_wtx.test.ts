import { ResponseCV } from '@stacks/transactions';
import { describe, expect, it } from 'vitest';
import { parseTx, parseWtx } from './clients/clarity-bitcoin-client.ts';
import { expectTxObject } from './utils.ts';

const accounts = simnet.getAccounts();
const deployer = accounts.get('deployer')!;

describe('Parse bitcoin txs with whitness data', () => {
  it('Ensure that segwit bitcoin txs can be parsed', () => {
    const response = parseWtx(
      '0200000000010218f905443202116524547142bd55b69335dfc4e4c66ff3afaaaab6267b557c4b030000000000000000e0dbdf1039321ab7a2626ca5458e766c6107690b1a1923e075c4f691cc4928ac0000000000000000000220a10700000000002200208730dbfaa29c49f00312812aa12a62335113909711deb8da5ecedd14688188363c5f26010000000022512036f4ff452cb82e505436e73d0a8b630041b71e037e5997290ba1fe0ae7f4d8d50140a50417be5a056f63e052294cb20643f83038d5cd90e2f90c1ad3f80180026cb99d78cd4480fadbbc5b9cad5fb2248828fb21549e7cb3f7dbd7aefd2d541bd34f0140acde555b7689eae41d5ccf872bb32a270893bdaa1defc828b76c282f6c87fc387d7d4343c5f7288cfd9aa5da0765c7740ca97e44a0205a1abafa279b530d5fe36d182500',
      true,
      deployer
    );

    expectTxObject(response.result as ResponseCV, {
      ins: [
        {
          outpoint: {
            hash: '4b7c557b26b6aaaaaff36fc6e4c4df3593b655bd42715424651102324405f918',
            index: 3,
          },
          scriptSig: '',
          sequence: 0,
        },
        {
          outpoint: {
            hash: 'ac2849cc91f6c475e023191a0b6907616c768e45a56c62a2b71a323910dfdbe0',
            index: 0,
          },
          scriptSig: '',
          sequence: 0,
        },
      ],
      locktime: 2431085,
      outs: [
        {
          scriptPubKey: '00208730dbfaa29c49f00312812aa12a62335113909711deb8da5ecedd1468818836',
          value: 500000,
        },
        {
          scriptPubKey: '512036f4ff452cb82e505436e73d0a8b630041b71e037e5997290ba1fe0ae7f4d8d5',
          value: 19291964,
        },
      ],
      version: 2,
      txid: '3b3a7a31c949048fabf759e670a55ffd5b9472a12e748b684db5d264b6852084',
    });
  });

  it('Ensure that large coinbase tx can be parsed', () => {
    const coinbaseTx =
      '010000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff2d0363a90d163c204f4345414e2e58595a203e0f0f3243525f4231000227700e5952b0ccf0cc24a8c40000000000ffffffff2c0000000000000000166a144f434231a430dd4f1600000029000000acd8c71b8b0410000000000017a9141052313d20c9145492dac7dadcb33354ff1071ef870622e1020000000017a9142b636a84e5b12177cd49c687b5a1ebd07fb83fbf8796734602000000002200200aee90d8fd95691d461546eb2ab688d7b1e4413dfcb8485c923a6981bece769de0b6040200000000220020ac11a29a5721e9602e396acd7e5216c9196b7dbb14cf573921c46e6fea38ac093151e70100000000220020d2628cb629f5608ec44ac2324cdd94497fc28f41a7460626b520a04aa17232ffc0259801000000001600146983f7fe983e96dc5b43677fb14822a0755963643c27750100000000160014d192719c5be868068f023b9383b3cbecb6afbb162fd1640100000000220020dc406857cac1b9d3f53c6986acb78e7774c604281076d10d3fc8e873e18df6d087635800000000001976a91412c00ad1271bd4c91e4f8ff11e738c285181399d88aca8f9570000000000160014b327f5cbe636766cd34a36daa417a0bd3f3f2c301f0e47000000000016001404afd9f6e36ba7cadb62133c458a5318f41a33ded1f446000000000017a9141ef31e9bc9ccb532b8c01950727990cca190656a876631320000000000220020e65791d3c340710f7aebf117d1f38e1c5383c1df0345a2082e8ebff945e999468a60310000000000160014100bcb0235295bc6a1b91ed543cc87d9c0c4a6b83dca2e00000000001600148daabc38895ce614a89f2f60c8aa2484c58f2d57cb1a2600000000001600146d095474bec41ccc8ad40f94c74dd25b79b83579d3a42200000000001600147a005ea5478b85f6c730c56c2606edff07949ad6823f1f00000000001600140345e587cb42c201c30e505ea9f6f5fb935876acbcb81b000000000016001472fb714ecb210311655a3da22729ff8626bdea59608c160000000000160014a2d379dbb47a38c9839e9e3a2df292e6255c5d3a1a8815000000000016001465c924de97963d4209528a613d627a5bc72397ed723414000000000017a914278dadd16d1314122e4dde67ff9152a61c3a9f478774831300000000001600148826b6c481b029409c931f8df786c092ccf21469456f130000000000160014e8dc41c47939430293f45747ea47e3325a536ec6511d13000000000017a9147a6d8577087d78c261d9d292ea838c9c623ea71c87e24112000000000022002061a2b0a1d72c46828464e83fd2bd986619691a544ca1b7dea6d7b9f5d4259010273f120000000000160014dd8f9b751054ab03f19ba0d36bf8ca50595e7466b1f3110000000000160014542296c4e9ed1fd643e3b1ddb7ff0022acfd781d8fb3110000000000160014f67490875247efb7314b26d1f0f331b75bb4df65b09f11000000000016001420173973b42d0d9334bd92ca231b65665fb3cb0ef8c11000000000002251202505b1ae10be41185da7c0561fd3f4dc56630e9d49264429046777a778f0ab7e1db7100000000000160014b7e81bc54daaad630b3d8da1c20418ce0aa157ad3b8c100000000000220020b0cb7174384edc43c645a0a44ffbb70d8ecf5d0d9912fc819e2970f89af38f5d3e73100000000000160014f6848b0a9c8408abfe956345e9b1e02eacbe9d58315f100000000000160014c5f79480fc5417e2ba5762e89fbf357828d2c2a0b25b10000000000017a9149f31679a6a7d7c22668bb467ac490e950d74dbdb87a64a1000000000001600141945bdbff512289c7cdcfd7158142f23abe4ea52853810000000000017a91468750c2ae538b335f5ebdcdc95b42b148ebce51487d71d100000000000160014b5f7ede18ab02fd488f21387ed4c93d9746d2eb2821b10000000000017a914e41c245e9565123b7441a2532bb58143d6a71bf687b40810000000000022002087a0ae628cc3a8af31ce2132e4cd85e25aa965642560a0e6c9d410507d422b3274c075010000000017a914413b5901fe4e591c95405fd446b5b002da575bf0870000000000000000266a24aa21a9edb1a2db0eeaa343388018b6c539bdb0944f563a5d5c8d9c231d20dbba88ed0da20120000000000000000000000000000000000000000000000000000000000000000000000000';
    const parsedTx = parseTx(coinbaseTx, deployer);
    console.log('parsedTx', parsedTx);
    expect(parsedTx.result).toBeOk();
  });
});
