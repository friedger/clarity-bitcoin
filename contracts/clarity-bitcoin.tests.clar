
(define-public (test-read-varints-8-zero)
  (let ((result (read-varint {index: u0, txbuff: 0x00112233445566})))
    (asserts! (is-ok result) (err result))
    (asserts! (is-eq (unwrap-panic result) {varint: u0, ctx: {index: u1, txbuff: 0x00112233445566}}) (err result))
    (ok true))
)

(define-public (test-read-varints-8-252)
  (let ((result (read-varint {index: u0, txbuff: 0xfc112233445566})))
    (asserts! (is-ok result) (err result))
    (asserts! (is-eq (unwrap-panic result) {varint: u252, ctx: {index: u1, txbuff: 0xfc112233445566}}) (err result))
    (ok true))
)


(define-public (test-read-varints-16)
  (let ((result (read-varint {index: u0, txbuff: 0xfd112233445566})))
    (asserts! (is-ok result) (err result))
    (asserts! (is-eq (unwrap-panic result) {varint: u8721, ctx: {index: u3, txbuff: 0xfd112233445566}}) (err result))
    (ok true))
)
(define-public (test-read-varints-32)
  (let ((result (read-varint {index: u0, txbuff: 0xfe112233445566})))
    (asserts! (is-ok result) (err result))
    (asserts! (is-eq (unwrap-panic result) {varint: u1144201745, ctx: {index: u5, txbuff: 0xfe112233445566}}) (err result))
    (ok true))
)

(define-public (test-read-varints-64)
  (let ((result (read-varint {index: u0, txbuff: 0xff112233445566778899aa})))
    (asserts! (is-ok result) (err result))
    (asserts! (is-eq (unwrap-panic result) {varint: u9833440827789222417, ctx: {index: u9, txbuff: 0xff112233445566778899aa}}) (err result))
    (ok true))
)

;; @name try to read txins of tx with 10 inputs
;; txid: 22fbb0e9488bbd79363511cf70e736f434c7ced6f0c9c678a2c9f638007d3823
(define-public (test-read-txins)
  (let (
    (tx 0x0100000000010b9b9c7ede9e627e28554c89299ace1f059e1db31e4e39944a8f1c7c93d26d96360100000000ffffffff8ba6d6b2b1bffbc659461219ee3a1b97a760a912dd599393920218f79e6a02430000000000ffffffff047b5457e71c6591b0c93660cfb1543d1208711678083a1751abdda8c2bca3a700000000fc004730440220631aad9885f4fe575163be069df6227ee36dd20d925f77dbbd12fdc4a48bc6e3022065befd89086f3a6b2115e62c0ba4ce50cfb4e866b3f7c72e9cd1064fb0629fb3014730440220647c0399beaee128b38b0bdb386a1f9854626191fbe515c5634782242eea1300022012f2388191c4bf89d3f00c8ae365ccc876d5f871916a6bb71d9f2a0dce8ef628014c6952210218d1c463e57f7f185c0c373022a99e53d07d37749965a9d811d69ecdc6eb666b2103fa1d2244418b5e5463bc29ca64b854521b11c80f2e429b2ab05d37ddb7bcf54d2103d618ce6aa14beaaa2164e8c74d16885a646512cca06f66f31181bab3469ada2a53aeffffffff44f20fbc918679c4d226ac57b4825ca7bc95e6b5d0adcce96c146be54d9db8d200000000fdfd00004730440220138672ad8b72c9eb76f268f3ea35719ca388b9b52c7a8523f88429d86671a766022037d4308f6d6db452eac0b57a454c1c2573adccd10ae63edc98c6f4bab9503b0f0148304502210099bc54b48d6cd39d1171229030b1d0705f9799ffb920d60a2bbb8c5be6faa0b3022033ffda30601e8ce472c2b782ba8af3f38e1085e1fa0072e5a64491b180687390014c6952210218d67a00a5404754f06b225aa2dc5ce5df249d24e36f76667a0b8feecb2aa39d2103002653b65b53018ad5d433115f602a5f70fa0c4dd773dc1c6c247a23a4435b0b2103366e7bc89aa358957097839f22a636d9eaf536375d100a44cdfa4083a5d921d853aefffffffffa105c600ad67e50a467f0245db6d928915c903fc45bd923f15341c2498428ec00000000fdfe0000483045022100d429a59020c6a58ba20a3580a8efa9e22c94a4cb28646af0c933b536d5db4e5502205f87bebca92d3a8bd90b293c7b59e795ea0ff8a1abe9912ba3e96bdd58f6539901483045022100f66785b825aa03bb7671f63429c0a86f887843dfa005a012bf75024a2b057ae802206d252832d5698fc7ff9b02efba306a55b77cc717b84d8ceed5a7c874daf01a29014c69522103357db6cc594a55a2c2be7b47ce438ba1e9869879695aa90a583dcdfeea2234ed2103daa551c0f44cbc90ba02a5f01047e6b8cba3381f49e0f91d00a8a4aeba88e22f21030e9d5a1fc1c27af5e7eb9d7fbab1aedf752471b087dde50969b19f04429e4e1653aeffffffff2e2fba20f1e0f7821cde712d085ca87b2ad6c96e35e019854c1acf230905a4b500000000fc004730440220707b29cf4f7dbee9c433102ae38ada2934fb0b6d58967eead2d2516e8ac47809022079bc462c5833381a5dc94d3aeef8a9c2ca4fe3a96db2ac1c52c4f778929c542001473044022009645b4491469952d45297e237404b79905348e32edf278ff3c28f91d6db321902202fc8c95144e367d2fcc88c066bd8516a2b06849329ece8917ac08262650c5c80014c6952210240e0419ab49aa200c4f8e3f2d377ea16d2a15f5ce49f07c64be25ed33502191321031565b10587835ef1a5ed4c08b7b977a397689c8a6884fe1b2504ae6cc6378cfb2102f74938e94cc396bb0516507a651618cfa804a0021fb704267327fb127b56b3d953aeffffffff153813cf1edb1ce5aa0cd2725a2aef0a35b57e840b40fe670e06fac7838103b700000000fdfd000047304402202e39a6bbe002d52e4fbf2edee4a819a9555b6cd686cece0ea82decefb90df4380220183903206941857696a4e31f40ce6d2a1bae53a47df38c894462f8192bc05c1701483045022100e7fd464e73fd7a8bc7075800897a0465ccd99e6087036061ed2758f2689c393202207ff9e22dba62c55da198fc2f307285e51cb48818f7ab2749e8bddeb90dc6e1c4014c6952210240e0419ab49aa200c4f8e3f2d377ea16d2a15f5ce49f07c64be25ed33502191321031565b10587835ef1a5ed4c08b7b977a397689c8a6884fe1b2504ae6cc6378cfb2102f74938e94cc396bb0516507a651618cfa804a0021fb704267327fb127b56b3d953aeffffffffbc4c173252561d7706007ecf8d0b409fa2f040ba63ade2ec13826440f00bc8bc0d00000000fffffffff3c5c010e892ec8ac7f4eb267abdd32329a3ccd8241907bec91f8c97d0c2125b00000000fc004730440220640d8ec19fbb1ead9da35e3182ac4b3848be64f9159ff29c6aebec7138c20c4a022058c9d5106a975e5516cfce4ecf1bb4e308ca5a221ab9a021c87c7387570dc62a0147304402207850e395673d505c90f0869eff20f67736bace235ca961aeb6faca1c7a87105c02200d7addca0c0b20bbb502cd2d94c70b9917c1bf9b321c1a5a74b2eb651af286e8014c6952210240e0419ab49aa200c4f8e3f2d377ea16d2a15f5ce49f07c64be25ed33502191321031565b10587835ef1a5ed4c08b7b977a397689c8a6884fe1b2504ae6cc6378cfb2102f74938e94cc396bb0516507a651618cfa804a0021fb704267327fb127b56b3d953aeffffffffe3860e47856525159bddba008da8fd749ef54463d2d4f3c3ea4c0839512a0a1201000000fdfe0000483045022100ec03eb5ec26f7d85f28294747654876f06da29f32bfc28620fb4c0b2f77d8189022063c1910aef2921a94de3e8e61acb44154754c91eb6f96322dba3d47c9ad9625701483045022100c0e675b453943126c7c51e697d08b34450145a035587071845284c36707163f902202ef35e679db969e3287ff53927c1a923655ddc0c421cea0b90926e98c16b9664014c69522103539605c087f1acd23035fe55aa30d0961c98684238b317ee719e5a7623f5d4ce2102e77b4104f41d484aea11ea3551dba6f62f26b14855518b00e03c491821defb9a2103e2fde0764ea302bcefbf5691bf282527850c39f094fc039272fcbdc14d5e8e8753aeffffffff411cffafb443f0f6c36bf321eee06dcd03395809e851ac85f80d04cc682958e30800000000ffffffff0a00375f000000000017a914cdd60c80f6f574da0e499a8006b29b5007d434a687af5aa40000000000160014a00faf9355cee3ce7d997829307b688023cc3aea60186bee000000001976a91447ecb7761bd21abffd0671b3d82e65e59c25f3fc88acd02c0c00000000001600142bdf779ef8474704335bad6c684d38cec27dc91d8e2b2900000000001976a914f83b8ede0aa1c75aa677467d8103fa5568f06a9d88ac386d050000000000225120d2db3e3cf9bc85abb8e25babf79a67f7f7454d364e27cf516f853d88a7fecdfdd7bb67020000000016001493f4264fbe4bb88b82366f34f3bd22bae8aa91e0a0860100000000001976a914fe22c69bb4db54bb23cf15370e12114034e3061f88ac69362a0000000000160014cb76d3719e0f8c6e933c93acb32b5b9f7b328e0fbf70bd0100000000220020e5c7c00d174631d2d1e365d6347b016fb87b6a0c08902d8e443989cb771fa7ec0400473044022005bcd7ffa1641e624e6414886feadea7cee437017d289361e8bfd6e64d30c182022039327af6722461683e3bf98b7551c3cabd77a01cf3ad3f7458b6ba213d2d8b98014830450221009074a3aab0031e43fa15256b1e5ad3f736b296db31998ca2fe784d3790a8192902202af32944b58415ce7e31184e4db8ab6d53124c99dc6cffa17486c2136bc7030601695221039859358416537517aeedeb3c28ffbf7a467bb78f35340e2595a608559950924721037ce9d5c70c0e38bbba66df7075d20738948058e62d69c578cb45114317e25ee1210389be2227f2ba88e9994830871e0e672d3fac4d68361b262a4b066246e53306f053ae04004830450221009f77b8ebdbaeef367d8e97797ad8a695f44c3b2930926afbd0d4205fa93dc4a6022040b6bd55883857b6c9eae1201da3abd7152734a62e5deb7c9eeeb7af508b301d01483045022100a6f02384815a5a0a954bdfaa19b829a9a85d8a7d83999f73ba7fdc0d00c4e6d502204aff2524aa8a1519678ba3c898db07b1846c84b5d7f0ef66061b1b6af02f4b2701695221039859358416537517aeedeb3c28ffbf7a467bb78f35340e2595a608559950924721037ce9d5c70c0e38bbba66df7075d20738948058e62d69c578cb45114317e25ee1210389be2227f2ba88e9994830871e0e672d3fac4d68361b262a4b066246e53306f053ae000000000004004830450221009909c9b2c7008a996985b056b7516e2d5ff150c747282a628e2e3a254dee6d2402203eee2719df04f287815c712d1f6ef7f8cc9f14a45e784d7c9688efb549d180610147304402203b56107a5248c8ab4287be690623169c531cbf9e2771895f840c4010a1881c7b02200f02e110838bdaad4e5a20e6df35d78bb9a94bc0897543263298187b4183a10801695221026064e5b88c4fff7dba7dc0300db8dbfc1faff14f9ddbaacbcaa4f70124de0e93210331870350912385ca9a9d537e9cf9d80c6c9558e31d654f82f3164fdc5955e9642103c7b133a0f463a501d8c58c8eb8c7b6e9e4ddfb7d4a7bf6365a4732201569bc8353ae00000400483045022100b35603383f85ddd5327c79e8a79d08ea34953731f70b311b16caa00a6440e7c3022074da71aa45e8e3e0ca942dfcdd63cf341577f738f222d11bd59d000d3318ec1401483045022100dd824d429a6d317bcabcd1bb31953ac8ea76dbd69eaef368d0b23c15b000c44302203cb15f10229de8d4cca99dc0a79622752ef685af68800eba86e6a679bc7bb3b901695221026064e5b88c4fff7dba7dc0300db8dbfc1faff14f9ddbaacbcaa4f70124de0e93210331870350912385ca9a9d537e9cf9d80c6c9558e31d654f82f3164fdc5955e9642103c7b133a0f463a501d8c58c8eb8c7b6e9e4ddfb7d4a7bf6365a4732201569bc8353ae00000000)
    (result (read-txins {index: u6, txbuff: tx})))
      (asserts! (is-ok result) (err result))
      (ok true))
)

;; @name try to read txouts of tx with 10 outputs
;; txid: 39edd81aa374a3fc590b4f118efb02273593caa2ba941559b6e56e6f3309cbd4
(define-public (test-read-txouts)
  (let (
    (tx 0x01000000000103aa981c0c66b5f29c9125136bf1fcc1d4b06b990f49a2bf3f4da8ed9a0901c62600000000fc0047304402204deede93a9d1fafbc08160042b5a577e2977b4d57ee827469d78672eae660bd9022069735e1249d2988f31e7fa665f6c5611b7220ae2c040ddbbaf682312a95cfd5401473044022071181566837a7483909fc9d39b8e6ff2c7219fa0d9f84938cc4f560d4b700ff102200215ffa6633ed432d93749be7527ad4bda6545543dfaae3fed4dc4327822e419014c6952210301286b902a17167257aa4e6b7378c42039d05d5c856844835446c149d0e874ae2102b4d90713d1c291b9a24c10e75220d0e1e12bf30a5e8669e181a90c4f1079bc8121020d79724c15771923cf9957d7053bd80abe0a6aece4835775087c8e72a63c34fd53aeffffffffab5a4f02c3b740a47a7b6fee9125657432cbd73e4627151cc4e1b088c7e101ba0300000000ffffffffb43a6d06c64e2a105bc2a339d802a8544c78ccd54a6804385efaa0868047b0d800000000fc0047304402207fb4a9c5ccc8abb0cb68398e54b6548d03824b9af6046327c1ee68ed7fe51a810220347a62c094ed225cba0d3f831461c222be39dc6d6a61a31a36c2c8a4e98aea4c0147304402202dd1424b3cf00c9c6bc05f3034cd1774864d0f419e73edba0f59ee392ab989a302200cb5002787613354fb5749dcad37387ab96e89f6b5db4dc963fea3952e314f0e014c695221025d2ade738149943d25628f8eac89019b7de29cd48f315b97ae33d66e73fbaec82103091d8e82ba9e1537a49d0890f6a7398c091eb10dd24057aac399d80b70f5179e210391a811ec40a7ca4efe671078f013b1d8308788f67da52720162306f9e9a624e553aeffffffff0a9c3e02000000000017a914afca0d408ae72adc9873d7aecf6606666fdf44d787f1b101000000000017a9147cad3c4095aec2b59fa0ea9a7fb55ba0c081c6e287af364d0c0000000017a914e498426ebfdbc21204e60682482ab1443d0b4fea8700093d0000000000160014c3270c47826bd88a1a6ae9aa4dbcb7aa3a1fa645c0c62d00000000001976a91403c0718ebc2bb7961859dc5dd1f0495d199067fe88ac8688670000000000160014cb5385b7ab0e68d90292951667c391e3b0947b96f40f0b000000000017a9140e5c035423d49cdd7d806feabf6362d07b9331fc87e01b18000000000017a9145f4110da3b787fb6ddd75c8b26c495c0c9bfc4db87485904000000000017a9141abe89eac94cde04b90de1605ae112c92054f03f870fa6520100000000220020e5c7c00d174631d2d1e365d6347b016fb87b6a0c08902d8e443989cb771fa7ec0004004830450221009b03a576d52fb1c4cf24deb5deb3d443a052acd3e6d770af4f3fab4bd8764ed002202c02a4f1d98cade0d1bb5d9e33e2472329ed670c48b5a22b4004cacd50c8dc5101473044022036573e0eddbfec14ab741425f8f36a11116cf612d4eb64de6c2e7acb38b6a1a102207fab226452d0d09beaebfeb321080d5d5de0696b9a79921ea6df196686aa973d01695221026064e5b88c4fff7dba7dc0300db8dbfc1faff14f9ddbaacbcaa4f70124de0e93210331870350912385ca9a9d537e9cf9d80c6c9558e31d654f82f3164fdc5955e9642103c7b133a0f463a501d8c58c8eb8c7b6e9e4ddfb7d4a7bf6365a4732201569bc8353ae0000000000)
    (result (read-txouts {index: u634, txbuff: tx})))
      (asserts! (is-ok result) (err result))
      (ok true))
)

;; @name try to read witnesses of tx with 0 witnesses
(define-public (test-read-next-witness)
  (let (
    (tx 0x00)
    (result (read-next-witness false (ok {ctx: {index: u0, txbuff: tx}, witnesses:(list)}))))
      (asserts! (is-eq result (ok {ctx: {index: u1, txbuff: tx}, witnesses: (list (list))})) (err result))
      (ok true))
)

(define-constant test-contract-principal (as-contract tx-sender))
(define-constant zero-address 'SP000000000000000000002Q6VF78)


(define-public (prepare)
	(begin
    ;; 1
    (unwrap-panic (add-burnchain-block-header-hash u2431087 0x0000a02065bc9201b5b5a1d695a18e4d5efe5d52d8ccc4129a2499141d000000000000009160ba7ae5f29f9632dc0cd89f466ee64e2dddfde737a40808ddc147cd82406f18b8486488a127199842cec7))
    ;; 2
    (unwrap-panic (add-burnchain-block-header-hash u2431459 0x000000207277c3a739ad34a3873a3c9d755f0766e918f4b37adcfe455d079b93000000000bad83579d633d37aa1e2bb725b8a5bad35509374454f1adad8a4de140066d74dbf64e64ffff001d6616bfe2))
    ;; 3
    (unwrap-panic (add-burnchain-block-header-hash u2431567 0x000000208af1a70ab2ed062c7ac53eb56b053498db50f0d9c41f0dc8a5efcb1b000000007b64b9e16eb97b1fb32977aa00e2cb7418856b1e794e232be4f3b4b0512cb31256845064ffff001dc3cdbab0))
    ;; 4
    (unwrap-panic (add-burnchain-block-header-hash u2431619 0x00c0c8306c887f5b2248021d1a6662aa684ca46975a21685800192b3f4e5c8b400000000a140532ff49146607e72df19983ff1e4a56f989cf0671aeb4ee321a74d3670c75c545164695a20192b1ab0c7))
    ;; 5
    (unwrap-panic (add-burnchain-block-header-hash u2431567 0x000000208af1a70ab2ed062c7ac53eb56b053498db50f0d9c41f0dc8a5efcb1b000000007b64b9e16eb97b1fb32977aa00e2cb7418856b1e794e232be4f3b4b0512cb31256845064ffff001dc3cdbab0))
    ;; 6
    (unwrap-panic (add-burnchain-block-header-hash u2430921 0x00004020070e3e8245969a60d47d780670d9e05dbbd860927341dda51d000000000000007ecc2f605412dddfe6e5c7798ec114004e6eda96f7045baf653c26ded334cfe27766466488a127199541c0a6))
    ;; 7
    (unwrap-panic (add-burnchain-block-header-hash u2431087 0x0000a02065bc9201b5b5a1d695a18e4d5efe5d52d8ccc4129a2499141d000000000000009160ba7ae5f29f9632dc0cd89f466ee64e2dddfde737a40808ddc147cd82406f18b8486488a127199842cec7))
	;; 8
    (unwrap-panic (add-burnchain-block-header-hash u895331 0x000000289ae31c64a91ed66c9e10338273dbc6fb85718973060c01000000000000000000ec632cf19fcf973835da9999ca8237bb85ce194b20332b1b32e188290284348385891868ed5c0217997b9d99))
	(ok true)
	)
)

;; @name parse raw coinbase transaction
;; @no-prepare
;; arbitrary coinbase transaction
(define-public (test-parse-raw-coinbase-transaction)
  (let (
    ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
      (raw-coinbase-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff23036f18250418b848644d65726d61696465722046545721010000686d20000000000000ffffffff02edfe250000000000160014c035e789d9efffa10aa92e93f48f29b8cfb224c20000000000000000266a24aa21a9ed260ac9521c6b0c1b09e438319b5cb3377911764f156e44da61b1ab820f75104c00000000)
      (parsed-coinbase-tx (parse-tx raw-coinbase-tx))
      (ins (list { outpoint: { hash: 0x0000000000000000000000000000000000000000000000000000000000000000, index: u4294967295},
        scriptSig: 0x036f18250418b848644d65726d61696465722046545721010000686d20000000000000, sequence: u4294967295}))
      (outs (list {scriptPubKey: 0x0014c035e789d9efffa10aa92e93f48f29b8cfb224c2, value: u2490093}
        {scriptPubKey: 0x6a24aa21a9ed260ac9521c6b0c1b09e438319b5cb3377911764f156e44da61b1ab820f75104c, value: u0}))
      (expected {version: u2, ins: ins, outs: outs, locktime: u0})
    )
    (ok (asserts! (is-eq parsed-coinbase-tx (ok expected)) (err parsed-coinbase-tx)))
  )
)

;; @name verify segwit transaction where OP_RETURN is in output[1]
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-1)
  (let (
    (do-test (prepare))
    (burnchain-block-height u2431087)
    ;; txid: 3b3a7a31c949048fabf759e670a55ffd5b9472a12e748b684db5d264b6852084
    (raw-tx 0x0200000000010218f905443202116524547142bd55b69335dfc4e4c66ff3afaaaab6267b557c4b030000000000000000e0dbdf1039321ab7a2626ca5458e766c6107690b1a1923e075c4f691cc4928ac0000000000000000000220a10700000000002200208730dbfaa29c49f00312812aa12a62335113909711deb8da5ecedd14688188363c5f26010000000022512036f4ff452cb82e505436e73d0a8b630041b71e037e5997290ba1fe0ae7f4d8d50140a50417be5a056f63e052294cb20643f83038d5cd90e2f90c1ad3f80180026cb99d78cd4480fadbbc5b9cad5fb2248828fb21549e7cb3f7dbd7aefd2d541bd34f0140acde555b7689eae41d5ccf872bb32a270893bdaa1defc828b76c282f6c87fc387d7d4343c5f7288cfd9aa5da0765c7740ca97e44a0205a1abafa279b530d5fe36d182500)
    ;; txid: f1bb118d6663640d6571d08ee36ffff78130c0a6a959e69929f952e745e54050
    (raw-coinbase-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff23036f18250418b848644d65726d61696465722046545721010000686d20000000000000ffffffff02edfe250000000000160014c035e789d9efffa10aa92e93f48f29b8cfb224c20000000000000000266a24aa21a9ed260ac9521c6b0c1b09e438319b5cb3377911764f156e44da61b1ab820f75104c00000000)
    ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
    (raw-block-header 0x0000a02065bc9201b5b5a1d695a18e4d5efe5d52d8ccc4129a2499141d000000000000009160ba7ae5f29f9632dc0cd89f466ee64e2dddfde737a40808ddc147cd82406f18b8486488a127199842cec7)
    (witness-merkle-root 0x15424423c2614c23aceec8d732b5330c21ff3a306f52243fbeef47a192c65c86)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-wtx raw-tx false))
  )

    (let ((result (was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u3
      u2
      (list 0xb2d7ec769ce60ebc0c8fb9cc37f0ad7481690fc176b82c8d17d3c05da80fea6b 0x122f3217765b6e8f3163f6725d4aa3d303e4ffe4b99a5e85fb4ff91a026c17a8)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0x5f4a8858a112953111d5f94605c4dd8d04690eeeb9ffe2f435475d95943f2f3f 0x3348bf81aae79941662a902206b3ed2d285713668ab134c9e113548daea596fc)
    )))
    (asserts! (is-eq result (ok 0xc62ea13f720175da9c93507db2b586b1d0a84faea386bf448a5bc470c37d1104)) (err "expected txid"))
    (ok true))
  )
)

;; @name verify segwit transaction where OP_RETURN is in output[0]
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-2)
  (let (
    (do-test (prepare))
    (burnchain-block-height u2431459)
    ;; txid: 0edafd2b2e9374ede142d1b60f884b47aa7a4ae0a5d46aa9c1d63d2e8e27087d
    (raw-tx 0x02000000000101cbab643067979ec7a7c74bf49af775b20203df78e31b83b2d25510fe5897872c0000000000feffffff02b0631d0000000000160014f55fa4fafee59cccde7d6204029d388480d354b6ce32599300000000160014cc9957eaabf54d9fa7d1c0ae64bd0f95e0bd0cdf0247304402200f17b4dfafedf598db8c48551efc8cce14de071ef86a0c7494d593e7346856c702207f96c3382ed4ed855bc86ac5a6df2e283c1b06276176cae590abdcd6f7c491bf012102276dc68fca4dae0eedbd5b9d7b36baccaff56b777d103d169ec31ce25f04fd14e2192500)
    ;; block id: 000000004daafb5977a88c7111da740e77cf6dd5a417f343ed01374676266c36
    (raw-block-header 0x000000207277c3a739ad34a3873a3c9d755f0766e918f4b37adcfe455d079b93000000000bad83579d633d37aa1e2bb725b8a5bad35509374454f1adad8a4de140066d74dbf64e64ffff001d6616bfe2)
    (witness-merkle-root 0x9a0f41eac348c25620b76aa15f771a7972638e8423ce590cdbe1432c4f5726c0)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    ;; txid: 28f35a9c67a275e1cf8678c3f030f005b4c85ff8fcbf1742035ec39ebbdb5164
    (raw-coinbase-tx 0x01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff1603e319251300000062696e67626f6e67210001000000ffffffff02bbb329000000000017a9148746e880ec2156d6b527e1962456cff7720695df870000000000000000266a24aa21a9edcbc79776b99d0cc0c2d597ce40c92958ba98f3adb6e59ed27c3a03d1c1703e1c00000000)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-wtx raw-tx false))
  )
    (let ((result (was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u8
      u7
      (list 0xbcbc1fe72ca5d67f74099ac4f851cd6a266d2a42fa6c9a6244b11adf6a2f13fb 0xec7eee1209489f80c4a5df2a90f26ee0ba0838be6f00442e3e0ab9d095865b45 0x0ddfb056b3e566ac3b376a940b9eff66a77296ec200f427b158f1700b2a32398 0x922b21d35cda111feeb04cd69d2fa78312fd34614d34c4fbfd204730b6ef013f 0xcf4c5ecd88374f44ae63ba87f96ef20e0330a247434c219ce8f8fdbc7ace4401 0x04889c3c93e70474fe0724f5270e26d91c974fa7b642703286903350480e2281 0x762dd8d1161d1d32a79c98f6273b6feb50405446e861db0f32c7403a8bb310b2)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0x012e8988aa58e53ac700c22257237716f642aea5ad45c3f6420eb010bf2b37f9 0x10b71df80cc37bd92c746690a980a7f4187e6dbf8b973ac938f1b1b9d1ef25b6 0x897a09fa66156b753366b38236fd40fe7920db114722b3d7762826bf4930750c 0x2cf51c5e81f70b72c37fd8eccd8d3446c7c69c4d568acd23c9949c25bc1d3fb4 0x7d45568289180def6b91cdf6f89c692f3798872948b582a9f6fd5cc471cb67e0 0xe5fefbaf926e706c4ef331d172dcb589dfd6b997bee4ba6ddee4c7c6e2918549 0x097ae87e24dae74bb00a2bfe0aa3c14537ce04b048285ce69d98301bd9ddee8d)
    )))
    (asserts! (is-eq result (ok 0xfea94d1e37eee8642ebbd6f5b43f6d092d9ac197f921f4598117a833dbe55b68)) (err "expected txid"))
    (ok true))
  )
)

;; @name verify segwit transaction where OP_RETURN is in output[0]
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-3)
  (let (
    (do-test (prepare))
    (burnchain-block-height u2431567)
    ;; txid: 2fd0308a0bca2f4ea40fe93a19be976a40b2d5e0df08df1dd991b4df31a563fc
    (raw-tx 0x020000000001017d406bb6466e0da97778f55ece77ab6becc415c930dbe618e81e8dae53ba914400000000171600143e8d4581104393d916566886ae01e26be8f8975afeffffff0276410300000000001600143d5f37543d2916547fe9b1242322b22f6e46d6929c9291d8000000001600145b3298860caeb3302f09e58b7cc3cf58d0a6740402463043021f53943d5951726d73a952473b49aa44dde64446f106749806d6478b0bdc053102200863a4f25914f3032afa8549f329962e8ecc7c575a1aefc51102a566ff5ece70012103742fe8a7244ab8384b3d533eb19138e2758c2b7a2e351c9ec2b8912cf4e046c24e1a2500)
    ;; block id: 00000000096ae97d41a543592c3680477444acdc86c877aeb4832744691cb94b
    (raw-block-header 0x000000208af1a70ab2ed062c7ac53eb56b053498db50f0d9c41f0dc8a5efcb1b000000007b64b9e16eb97b1fb32977aa00e2cb7418856b1e794e232be4f3b4b0512cb31256845064ffff001dc3cdbab0)
    (witness-merkle-root 0xb2ea7fb39beae6b5a225c85cb7087561909e1d17bba74de3592a3c1da3944983)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    ;; txid: 84f8a86015b0a95763bb16128ff301a60f668356548405178953ab1e4cbff36e
    (raw-coinbase-tx 0x01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff32034f1a2500045684506404c862b40c0c11c14a6400000000000000000a636b706f6f6c0e2f6d696e65642062792072736b2fffffffff0317ea2b00000000001976a914ec2f9ffaba0d68ea6bd7c25cedfe2ae710938e6088ac0000000000000000266a24aa21a9ede2ee16ef0a8c0fd6ccb8c78f297199f0f143629121801c46b1e1487c0123cb4b00000000000000002a6a52534b424c4f434b3acb9b4841f625100fb87055003991835f3183bff7668865e93e1f1118003a492d00000000)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-wtx raw-tx false))
  )

    (let ((result (was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u1
      u7
      (list 0x0000000000000000000000000000000000000000000000000000000000000000 0x71f824a016ae0f58a01cb8a4aafb910c6013666640f43b745adc87dcc9118a66 0x3efcbcef748b6b46ce25fc94d455555851322f9bcbf36de02500492dacc8fcfa 0xbca0973353bed064af7388d48969f23b0dc65d8cb1c8eaae95890b7c08a39914 0x84211c0f3a64e0fab33d1ab9d537a60adab81bcb681f1297901aad5566683e56 0x8527cd4ff222ff5010726219744a19522e2d016873d4a8ca3bfa984f32cf7355 0x83fbd3b472c7e7285ad25fd40edaf658acef8756aecf32a115d98fd07d006af9)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0xfc63a531dfb491d91ddf08dfe0d5b2406a97be193ae90fa44e2fca0b8a30d02f 0x33274cc92f8b980272688e01114cc2944fb661d1aa3a658c7d29675a46a4d5ad 0x1172bf0943aad7bc580aaab5f5d356b1c172f11c297ccf0077515309906352f2 0x2af4fd00ac79b65c0c508fbf44c22d1cf5acb084770079a94bd72ac816cfceb8 0xed4ca325a1800f0dfb2ab9d63761ecb358c014424e684c820d0d87ace45474a1 0xd3292e0e550420e500f29663dfc8ef632dbcb119c8a1ddf49aa3d32ecad83084 0x6369b65eea600edbd69b56386be9269f9662ca3f384a0ca21922ac03d2936102)
    )))
    (asserts! (is-eq result (ok 0xbf986c2f7c53f7fc6f87ec605d4e4ff58aa1f4558fa4bfa7bc692d64277168da)) (err "expected txid"))
    (ok true))
  )
)

;; @name verify segwit transaction where the incorrect proof is provided and only the first transaction is given. should fail
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-4)
  (let (
    (do-test (prepare))
    (burnchain-block-height u2431619)
    ;; txid: c770364da721e34eeb1a67f09c986fa5e4f13f9819df727e604691f42f5340a1
    (raw-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff2503831a250000000000000000000000000000000002000000000000073c7500000000000000ffffffff02be402500000000001976a91455a2e914aeb9729b4cd265248cb67a865eae95fd88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf900000000)
    ;; block id:
    (raw-block-header 0x00c0c8306c887f5b2248021d1a6662aa684ca46975a21685800192b3f4e5c8b400000000a140532ff49146607e72df19983ff1e4a56f989cf0671aeb4ee321a74d3670c75c545164695a20192b1ab0c7)
    (witness-merkle-root 0x0000000000000000000000000000000000000000000000000000000000000000)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    ;; txid: c770364da721e34eeb1a67f09c986fa5e4f13f9819df727e604691f42f5340a1
    (raw-coinbase-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff2503831a250000000000000000000000000000000002000000000000073c7500000000000000ffffffff02be402500000000001976a91455a2e914aeb9729b4cd265248cb67a865eae95fd88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf900000000)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-wtx raw-tx false))
  )

    (match (was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u0
      u1
      (list )
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0x12b32c51b0b4f3e42b234e791e6b851874cbe200aa7729b31f7bb96ee1b9647b)
    )
      ok-res (err u1)
      err-res (if (is-eq err-res ERR-PROOF-TOO-SHORT) (ok true) (err err-res))
    )
  )
)


;; @name verify segwit transaction where the incorrect wproof with zeros only
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-5)
  (let (
    (do-test (prepare))
    (burnchain-block-height u2431567)
    ;; txid: 2fd0308a0bca2f4ea40fe93a19be976a40b2d5e0df08df1dd991b4df31a563fc
    (raw-tx 0x020000000001017d406bb6466e0da97778f55ece77ab6becc415c930dbe618e81e8dae53ba914400000000171600143e8d4581104393d916566886ae01e26be8f8975afeffffff0276410300000000001600143d5f37543d2916547fe9b1242322b22f6e46d6929c9291d8000000001600145b3298860caeb3302f09e58b7cc3cf58d0a6740402463043021f53943d5951726d73a952473b49aa44dde64446f106749806d6478b0bdc053102200863a4f25914f3032afa8549f329962e8ecc7c575a1aefc51102a566ff5ece70012103742fe8a7244ab8384b3d533eb19138e2758c2b7a2e351c9ec2b8912cf4e046c24e1a2500)
    ;; block id: 00000000096ae97d41a543592c3680477444acdc86c877aeb4832744691cb94b
    (raw-block-header 0x000000208af1a70ab2ed062c7ac53eb56b053498db50f0d9c41f0dc8a5efcb1b000000007b64b9e16eb97b1fb32977aa00e2cb7418856b1e794e232be4f3b4b0512cb31256845064ffff001dc3cdbab0)
    (witness-merkle-root 0xb2ea7fb39beae6b5a225c85cb7087561909e1d17bba74de3592a3c1da3944983)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    ;; txid: 84f8a86015b0a95763bb16128ff301a60f668356548405178953ab1e4cbff36e
    (raw-coinbase-tx 0x01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff32034f1a2500045684506404c862b40c0c11c14a6400000000000000000a636b706f6f6c0e2f6d696e65642062792072736b2fffffffff0317ea2b00000000001976a914ec2f9ffaba0d68ea6bd7c25cedfe2ae710938e6088ac0000000000000000266a24aa21a9ede2ee16ef0a8c0fd6ccb8c78f297199f0f143629121801c46b1e1487c0123cb4b00000000000000002a6a52534b424c4f434b3acb9b4841f625100fb87055003991835f3183bff7668865e93e1f1118003a492d00000000)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-wtx raw-tx false))
  )

    (let ((result (was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u1
      u7
      (list 0x0000000000000000000000000000000000000000000000000000000000000000 0x0000000000000000000000000000000000000000000000000000000000000000 0x0000000000000000000000000000000000000000000000000000000000000000 0x0000000000000000000000000000000000000000000000000000000000000000 0x0000000000000000000000000000000000000000000000000000000000000000 0x0000000000000000000000000000000000000000000000000000000000000000 0x0000000000000000000000000000000000000000000000000000000000000000)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0xfc63a531dfb491d91ddf08dfe0d5b2406a97be193ae90fa44e2fca0b8a30d02f 0x33274cc92f8b980272688e01114cc2944fb661d1aa3a658c7d29675a46a4d5ad 0x1172bf0943aad7bc580aaab5f5d356b1c172f11c297ccf0077515309906352f2 0x2af4fd00ac79b65c0c508fbf44c22d1cf5acb084770079a94bd72ac816cfceb8 0xed4ca325a1800f0dfb2ab9d63761ecb358c014424e684c820d0d87ace45474a1 0xd3292e0e550420e500f29663dfc8ef632dbcb119c8a1ddf49aa3d32ecad83084 0x6369b65eea600edbd69b56386be9269f9662ca3f384a0ca21922ac03d2936102)
    )))
      (asserts! (is-eq result (err ERR-WITNESS-TX-NOT-IN-COMMITMENT)) (err result))
      (ok true)
    )
  )
)

;; @name scriptPubKey or witness item is too large. Fails to parse segwit transaction
;; arbitrary segwit transaction
(define-public (test-parse-wtx-6)
  (let (
    ;; txid: b9c256b7e7e2ba040efce8ce025357efa21dc2a214b8f32bac467abe37c916b3
    (raw-tx 0x0200000000010194e3fe8a27244e016fc6ad68fff2d1915640162200f5c34da1dba4e58503dcf80000000000fdffffff014a01000000000000225120e9fd8d28e5ac36dfc511b77ea035c555c35280710447f4671f19bb7898f2c238034006bf239aeed4cdc9619f4ce12ab2c5fe9c7bc408ba90628d88f747f2c5c79138d3e76e3a2bd97a14c5c286727749320447c6f156279d2f3044bdf09eb9846c09fd2e0720790771426487634704e500433910781b5872c9276393054f79c220b8b3e0fc70ac0063036f726401010f746578742f6a6176617363726970740109026272004d08021b661951540c3e00340ee3e669403c5a1eb114ad63e0eaf36339fb7b2ea7571f2aace9acc977e717d2b21182ac98ce0c9dd64fb6b4d7ca361840af4c5394ab65cddeb4bb43198c4e0a5e1d0ee110ee3b4c5fdcafdacf4111a2a4aa67763fed87101d2109c76b83b63c8eeffdbb0fa49228deb99166d46888c9c86159ae35e8ae48028f1990c2fd7b0ab0bdddca83e3c99ab37aefc5fd9d409a07778bdadce20cc4b506917b11eea651bbb4471358853a7f3fab1a79b55824f7d4083d6cbba7013c7f47b77e5dea06e2ce0c9c96eec47f999b349d4741374a17432892c14b76b2ea5958d8c0f3c87528e7b4f05f4f3ab53925e2d611c9a1b4a6f4ecdd156646d128c3047f8d2dc234f2f9c32b61e590222a2f693572f1078b57e7260ad50dd5e4c51e531aec0972d7dff398bf4cb04e84e45b5eaba631a0e47c12bfd0dfd787efde9dfa3d8895ee1655c879c19b3d7d75797e7aa69b7ff784390ad408b0ac116d5e849a3d5e6eff3d87ca5172513571bd9fc723eec274ebef3f087d811018f4e18905c3b5ae15e5981e19a8fc6ff475c6eda69f614d883ce75f4c85b78318470c8a26df5536e3b363e7e168535c15fd26d4786793590ab2463cd97d2ad4624bbbd1ea9a51118197b94d989eca4416811c490eb39e49db19e82107c382d42cc469dd248de8eb9fec9166cb282a753a2765610a5533db83315223d42f3d67cf59a638058fe118a608504d080246dce850a596c2ef25dafeaf6c5eebb200ef219524c2f3747823ed03932849a4f3220884a16c4c0f33283b41a18040485f0f637619ac3218f5807f0261761bddc7dc5f3dff1bc3806f83ca845a83f9c348845ee36f9511d8a2854d173f70b1ec20761e32c52e7f93b6eca4fecde1e90981cb8eeb5c7055785acfc2182b1cd5adbceda4f7d3dbaa44cd0c9fb6a8dcea9ee7ff696398da9af7a9d154b55f0d7c69b21dac8ece129c5eea8f63da78d64e1abf409302cd51324f1a138f111d37c2265bab859f4d5ca9e555cc9820e05c76359e133e0ddc8d766ffd8ec92227cbfeb4b8b8fd65cb8fb692a6cc69da350e6cfc8ab1bcd211497a410833001f02c20ecf2f4f6c9e8393ac30c13048895d299a081ee0afe08616409e8bf121d6bf39763905109cb84e34ec08065ad023322cb2de7886214f0d2de29bdfdb632c5efd7e4869f7f0ca9dc1fa875245134eefcd656d83a8f4bc3bf7711c38bf965c5e38963444c41d24d85585009624629d52b1412050599d26bf01414082a1a061dc560ca0850f4e3d576e2b0518b7950610040109868286713b3a38cfefb80edccf6e4a5b2e383ab970e9eccab59bd2961b8e4e2e92843a19cd73038280045fadef4e56b36404150d78bfd1433513c72f4fa2c262dbe3ef64b5c09b19caa9fb58d07303d0b81a6ac86a0fbfd9a4c35343bf651fe27b13f000d877b512ca85cf49a9b93d699ab743cb0891abc24d08022bca30dd77518aab21fad61208b1ba8255b3d101abaaabab7afdec9da8da13a7deeed24271bf7c90533022583d5a577674a5b3ad6ad5375b975884461168a1c6b5cd957e1f0f04a65d65c887b45bded3297e7f763841af10e4a83a6273f9e79f82b2093cbf2d744cdcf9837ce1178cbc01835155b482dc2c589365c83f36f76d5c7ae107fe2e523b87834b5e49da326a23254d23b448e7ed610c55ec95dadc9eb4c7973eff52221036c264c35fb3b1172734cbf11fbfb1af244fb789276de211e9a8e5eef1f9498b197f4bdc0bd3b77fc6fce48b3706728703230aa7c39bb8b78947e1e313b8b557fe33f4d79f32c0bc814c108e4a2961c7ac1159520297927caf520d9233cc836e8d3854b8af7522187dc9b68c4842b7346ad9ab63585d747f7a1dca0846bff392ac5483f0e027f739fa72c260b9fc4d3661b42ddccdb5b3a245ae03615ee27aaf46a2ffaba6d27e5c9eabf806afd382417fb6ba0ac9ca56533186f182458655eaf4b982da4d820e25535913316c5592add561481bfb69e3b1d5df67e3a10d3a697e8d629eed36d04ff90c11da7b281b764e24c66915170bc2dfaa4b40f9e5c937f49c807effc1704398cccb20918b04eb961dffddf4dfeca2b8494f55854ef190e2631f321d45b8aca37234a78186fb60951516e6951786d85326b480d0f0a0b4d1c9e59cc87250d054ae2db6f6a71d860b846aff31f458844d5ca811c8af80604cca6474e07317f4243897b08199e168d2720eb325543a6e3ef4b6781bafbb34101a1f6e77c518d5924cc479219546d22af5022cb70b644cdb9b474dd29466adc9c64789b8c3030f82cf7ca51dfe1cfa6812c9cbe25d1bc73963f38fac599f59960ece194ce36187299bdf93ec46350dcdfdc354ea5ca61cf97841acc8a971cdcd8db2ec78abc7fdc4356eab489f10114bc6e0d26ad6b634b70302374ce8301b28ddec5ec5defa59b66a2c54b18e03079cc8b839f43b253bcb05b7e0eef90571cd2fae5b1e918c8ea4a43b006821c1790771426487634704e500433910781b5872c9276393054f79c220b8b3e0fc7000000000)
  )

    (match (parse-wtx raw-tx false)
      ok-res (err u1)
      err-res (if (is-eq err-res ERR-VARSLICE-TOO-LONG) (ok true) (err err-res))
    )
  )
)

;; @name verify segwit transaction where OP_RETURN is in output[1]
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-7)
  (let (
    (do-test (prepare))
    (burnchain-block-height u2431087)
    ;; txid: 3b3a7a31c949048fabf759e670a55ffd5b9472a12e748b684db5d264b6852084
    (raw-tx 0x0200000000010218f905443202116524547142bd55b69335dfc4e4c66ff3afaaaab6267b557c4b030000000000000000e0dbdf1039321ab7a2626ca5458e766c6107690b1a1923e075c4f691cc4928ac0000000000000000000220a10700000000002200208730dbfaa29c49f00312812aa12a62335113909711deb8da5ecedd14688188363c5f26010000000022512036f4ff452cb82e505436e73d0a8b630041b71e037e5997290ba1fe0ae7f4d8d50140a50417be5a056f63e052294cb20643f83038d5cd90e2f90c1ad3f80180026cb99d78cd4480fadbbc5b9cad5fb2248828fb21549e7cb3f7dbd7aefd2d541bd34f0140acde555b7689eae41d5ccf872bb32a270893bdaa1defc828b76c282f6c87fc387d7d4343c5f7288cfd9aa5da0765c7740ca97e44a0205a1abafa279b530d5fe36d182500)
    ;; txid: f1bb118d6663640d6571d08ee36ffff78130c0a6a959e69929f952e745e54050
    (raw-coinbase-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff23036f18250418b848644d65726d61696465722046545721010000686d20000000000000ffffffff02edfe250000000000160014c035e789d9efffa10aa92e93f48f29b8cfb224c20000000000000000266a24aa21a9ed260ac9521c6b0c1b09e438319b5cb3377911764f156e44da61b1ab820f75104c00000000)
    ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
    (raw-block-header 0x0000a02065bc9201b5b5a1d695a18e4d5efe5d52d8ccc4129a2499141d000000000000009160ba7ae5f29f9632dc0cd89f466ee64e2dddfde737a40808ddc147cd82406f18b8486488a127199842cec7)
    (witness-merkle-root 0x15424423c2614c23aceec8d732b5330c21ff3a306f52243fbeef47a192c65c86)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-wtx raw-tx false))
  )
    (let ((result (was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u3
      u2
      (list 0xb2d7ec769ce60ebc0c8fb9cc37f0ad7481690fc176b82c8d17d3c05da80fea6b 0x122f3217765b6e8f3163f6725d4aa3d303e4ffe4b99a5e85fb4ff91a026c17a8)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0x5f4a8858a112953111d5f94605c4dd8d04690eeeb9ffe2f435475d95943f2f3f 0x3348bf81aae79941662a902206b3ed2d285713668ab134c9e113548daea596fc)
    )))
    (asserts! (is-eq result (ok 0xc62ea13f720175da9c93507db2b586b1d0a84faea386bf448a5bc470c37d1104)) (err "expected txid"))
    (ok true))
  )
)

;; @name verify segwit transaction where coinbase tx has 44 outputs
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-8)
  (let (
    (do-test (prepare))
    (burnchain-block-height u895331)
    ;; txid: 0f3885e3f721491fc1c5df5ec3378a7f314d15bc7b1a53aa5c82b24f0ce8f6d8
    (raw-tx 0x02000000000101bf0a791c63dde698e90cbe08b9380660aa915af65fd0d0dd6c1e7d044836346100000000171600140f66bf9b851c7246c78b243b3104501a0032a1d2ffffffff0300000000000000001f6a1d0c0000000101700516e89cf3fa48087bd2831e48f560de473f8b1b898f18f600000000000016001420e180ca60ada9fe947ceb64c7aba1cd0e2babbe0c3203000000000017a914ad157f8359fb3ab1b5d9e4574fa8c53e5113d7368702473044022026bb7b3841dd8f545e01e8bcc72976245e1e175968360eed472deab4bd91912502202c47c1dc38886b279e8370105bdc3590c69cc4c2687a79eb60dfc33e3f82166701210294af4e532bdacd81531a9fa89464fccb65050cfd6b3532905dc46d3cbf29c94b00000000)
    ;; txid: 169e09fa993ed0ad1476b2db432765194a0266469b91d9e5efb251f58f70984e
    (raw-coinbase-tx 0x01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff2d0363a90d163c204f4345414e2e58595a203e0f0f3243525f4231000227700e5952b0ccf0cc24a8c40000000000ffffffff2c0000000000000000166a144f434231a430dd4f1600000029000000acd8c71b8b0410000000000017a9141052313d20c9145492dac7dadcb33354ff1071ef870622e1020000000017a9142b636a84e5b12177cd49c687b5a1ebd07fb83fbf8796734602000000002200200aee90d8fd95691d461546eb2ab688d7b1e4413dfcb8485c923a6981bece769de0b6040200000000220020ac11a29a5721e9602e396acd7e5216c9196b7dbb14cf573921c46e6fea38ac093151e70100000000220020d2628cb629f5608ec44ac2324cdd94497fc28f41a7460626b520a04aa17232ffc0259801000000001600146983f7fe983e96dc5b43677fb14822a0755963643c27750100000000160014d192719c5be868068f023b9383b3cbecb6afbb162fd1640100000000220020dc406857cac1b9d3f53c6986acb78e7774c604281076d10d3fc8e873e18df6d087635800000000001976a91412c00ad1271bd4c91e4f8ff11e738c285181399d88aca8f9570000000000160014b327f5cbe636766cd34a36daa417a0bd3f3f2c301f0e47000000000016001404afd9f6e36ba7cadb62133c458a5318f41a33ded1f446000000000017a9141ef31e9bc9ccb532b8c01950727990cca190656a876631320000000000220020e65791d3c340710f7aebf117d1f38e1c5383c1df0345a2082e8ebff945e999468a60310000000000160014100bcb0235295bc6a1b91ed543cc87d9c0c4a6b83dca2e00000000001600148daabc38895ce614a89f2f60c8aa2484c58f2d57cb1a2600000000001600146d095474bec41ccc8ad40f94c74dd25b79b83579d3a42200000000001600147a005ea5478b85f6c730c56c2606edff07949ad6823f1f00000000001600140345e587cb42c201c30e505ea9f6f5fb935876acbcb81b000000000016001472fb714ecb210311655a3da22729ff8626bdea59608c160000000000160014a2d379dbb47a38c9839e9e3a2df292e6255c5d3a1a8815000000000016001465c924de97963d4209528a613d627a5bc72397ed723414000000000017a914278dadd16d1314122e4dde67ff9152a61c3a9f478774831300000000001600148826b6c481b029409c931f8df786c092ccf21469456f130000000000160014e8dc41c47939430293f45747ea47e3325a536ec6511d13000000000017a9147a6d8577087d78c261d9d292ea838c9c623ea71c87e24112000000000022002061a2b0a1d72c46828464e83fd2bd986619691a544ca1b7dea6d7b9f5d4259010273f120000000000160014dd8f9b751054ab03f19ba0d36bf8ca50595e7466b1f3110000000000160014542296c4e9ed1fd643e3b1ddb7ff0022acfd781d8fb3110000000000160014f67490875247efb7314b26d1f0f331b75bb4df65b09f11000000000016001420173973b42d0d9334bd92ca231b65665fb3cb0ef8c11000000000002251202505b1ae10be41185da7c0561fd3f4dc56630e9d49264429046777a778f0ab7e1db7100000000000160014b7e81bc54daaad630b3d8da1c20418ce0aa157ad3b8c100000000000220020b0cb7174384edc43c645a0a44ffbb70d8ecf5d0d9912fc819e2970f89af38f5d3e73100000000000160014f6848b0a9c8408abfe956345e9b1e02eacbe9d58315f100000000000160014c5f79480fc5417e2ba5762e89fbf357828d2c2a0b25b10000000000017a9149f31679a6a7d7c22668bb467ac490e950d74dbdb87a64a1000000000001600141945bdbff512289c7cdcfd7158142f23abe4ea52853810000000000017a91468750c2ae538b335f5ebdcdc95b42b148ebce51487d71d100000000000160014b5f7ede18ab02fd488f21387ed4c93d9746d2eb2821b10000000000017a914e41c245e9565123b7441a2532bb58143d6a71bf687b40810000000000022002087a0ae628cc3a8af31ce2132e4cd85e25aa965642560a0e6c9d410507d422b3274c075010000000017a914413b5901fe4e591c95405fd446b5b002da575bf0870000000000000000266a24aa21a9edb1a2db0eeaa343388018b6c539bdb0944f563a5d5c8d9c231d20dbba88ed0da200000000)
    ;; block id: 00000000000000000001cd83ba4ebc179970c571c67cf680f931ad57f392af93 
    (raw-block-header 0x000000289ae31c64a91ed66c9e10338273dbc6fb85718973060c01000000000000000000ec632cf19fcf973835da9999ca8237bb85ce194b20332b1b32e188290284348385891868ed5c0217997b9d99)
    (witness-merkle-root 0xc585ca76300bd5d5754ac8df404d6cdf2d416032f951843632fcb4b2bd803249)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-wtx raw-tx false))
  )
    (let ((result (was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u3456
      u13
      (list 0x611ab69bf8d6ad3f91ac374e8b5f33c7ffbb0da714a0650649955d961fdc0604
   0x1476db2e1773b3b8f2d8eb506d024d0cefb1a7ff174a24afa6f74f6da7bedbde
   0x4e335f7e3f0f89fe72fb22f103795d55a58ce0bec620a54d1619c1e7664bd357
   0xdc8480d5959858825b299bd0217612806b319ba36923b997b6b68c80d4b7d955
   0x08306a5bc8c3b5fe54cf9d1c5c0b8e330128418a6c85debeafa4b78724f5d44a
   0x7a8c8243425ab5bbdf913c65a7315c7cdd1b315cab02e023a188f40be7a67187
   0x7a1021da8ca5c6e398b77692898d404867b005c66e6dcc9925dbb2e3a9f725c9
   0x0756c3bfec8ccc4c09d1aa5e1e8e5f77dfc185e8ea10c6acc125f8877d717db8
   0x60674bf603b472c7758e76bc4fcf47bcb0e4f42c3c848b7f132b69359c411d52
   0x0657e66069cf14740635ec25fd8beeb5e5a2684b4f79a3701bfc7de82c599043
   0xe59fb131f53fd2796fab98c1fea7e26ebc3d33428921f4f239d5ddd53b2bd0f9
   0xf7152964931a80341eaefbfc9fe39c42c94bc23d8b5b6e447c4896b664570f68
   0x102364c7305152af68c7dec80752487b1746fbb4d7dc37b512476f9d4ffb2b54)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0x6f9dd42f32a45fb2208862699a8a3a55f22400e890f51d6759974918793d01ed
   0xe4f2928f30571a9a8e4f61715564c404416d61f12e7c2e5bcd0bde0eeb332b07
   0xc907ef913f71deb472ee69c73a0edc9519461476bec03f9667990acfe4a35bef
   0x91501e6db3906f99b25731579e04a027f676c95de322c353dd0bab2101b6e496
   0x8d0bc08d1a79a283f6d05f6b255e91e721b0bf285b45d7a12c4a15eba75dcc1e
   0xbaab3de115a6262645ed80c65116e9c8d45c3371134c80d4c05562a4d18b8c01
   0x711d45e4727f24ce65342d617c1256c50be0d77472d32bee4a6a7d298894395c
   0x0ad964110d3174605b4a55e13a181bdc68eaa6279f00c00375ae61bce4165fb7
   0x95b1d6f58fd463f2b978db1db3c14672676c2ced1a7b17fc0fa43d9b19f53d41
   0x4014fc658167fe3f222ff71a5600b2be1b21f0088b1350e3d7227f4376a2e933
   0xe27b7eb76fe79487b84213ecf44ba02094de7ed59b38d2bf0e85283ea339944f
   0xa0149080154b3f24992cac558875344b6b72eca71fd8231c93709d325995e15e
   0x3773030efef201607073b272df4eb43ebef20e26cd27b25312a0ee8658760b73)
    )))
    (asserts! (is-eq result (ok 0x5b19d69347d031587951d3a7fd7e143967b743610f876bbd86364e6f5feba796)) (err "expected txid"))
    (ok true))
  )
)

;; @name verify segwit transaction with left over data
(define-public (test-parse-wtx)
  (let (
    (burnchain-block-height u2431087)
    ;; txid: 3b3a7a31c949048fabf759e670a55ffd5b9472a12e748b684db5d264b6852084
    (raw-tx 0x0200000000010218f905443202116524547142bd55b69335dfc4e4c66ff3afaaaab6267b557c4b030000000000000000e0dbdf1039321ab7a2626ca5458e766c6107690b1a1923e075c4f691cc4928ac0000000000000000000220a10700000000002200208730dbfaa29c49f00312812aa12a62335113909711deb8da5ecedd14688188363c5f26010000000022512036f4ff452cb82e505436e73d0a8b630041b71e037e5997290ba1fe0ae7f4d8d50140a50417be5a056f63e052294cb20643f83038d5cd90e2f90c1ad3f80180026cb99d78cd4480fadbbc5b9cad5fb2248828fb21549e7cb3f7dbd7aefd2d541bd34f0140acde555b7689eae41d5ccf872bb32a270893bdaa1defc828b76c282f6c87fc387d7d4343c5f7288cfd9aa5da0765c7740ca97e44a0205a1abafa279b530d5fe36d182500ffffff)
    ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
  )
    (let ((result (parse-wtx raw-tx false)))
    (asserts! (is-eq result (err ERR-LEFTOVER-DATA)) (err "expected ERR-LEFTOVER-DATA"))
    (ok true))
  )
)

;; @name parse-wtx is unable to parse a non-segwit transaction (returns unpredictable values)
(define-public (test-parse-wtx-on-non-segwit-1)
  (let (
    (segwit-tx 0x020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff03016500ffffffff0200f2052a010000002251205444612a122cd09b4b3457d46c149a23d8685fb7d3aac61ea7eee8449555293b0000000000000000266a24aa21a9edab124e70e4a18e72f2ac6f635aebb08862d5b5b1c0519cd9f3222a24a48482560120000000000000000000000000000000000000000000000000000000000000000000000000)
    (non-segwit-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff2503831a250000000000000000000000000000000002000000000000073c7500000000000000ffffffff02be402500000000001976a91455a2e914aeb9729b4cd265248cb67a865eae95fd88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf900000000)
    (parsed-tx-with-segwit-function (parse-wtx non-segwit-tx false))
    (parsed-tx-with-non-segwit-function (parse-tx non-segwit-tx))
    (correct-parsed-tx { ins: (list { outpoint: { hash: 0x0000000000000000000000000000000000000000000000000000000000000000, index: u4294967295 }, scriptSig: 0x03831a250000000000000000000000000000000002000000000000073c7500000000000000, sequence: u4294967295 }), locktime: u0, outs: (list { scriptPubKey: 0x76a91455a2e914aeb9729b4cd265248cb67a865eae95fd88ac, value: u2441406 }  { scriptPubKey: 0x6a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf9, value: u0 }), version: u2 })
    ;;(wrong-parsed-tx { ins: (list), locktime: u0, outs: (list), segwit-marker: u1, segwit-version: u0, version: u2, witnesses: (list) })
  )
    (ok
      (asserts!
        (and
          (is-eq parsed-tx-with-segwit-function (err ERR-NOT-SEGWIT-TRANSACTION))
          (is-eq parsed-tx-with-non-segwit-function (ok correct-parsed-tx))
        )
      (err u1)))
  )
)

(define-public (add-burnchain-block-header-hash (burn-height uint) (header (buff 80)))
  (mock-add-burnchain-block-header-hash burn-height (reverse-buff32 (sha256 (sha256 header))))
)


;; @name verify transaction where OP_RETURN is in output[1]
;; arbitrary segwit transaction
(define-public (test-was-tx-mined-internal-1)
  (let (
    (do-test (prepare))
    (burnchain-block-height u2431087)
    (txid 0x3b3a7a31c949048fabf759e670a55ffd5b9472a12e748b684db5d264b6852084)
    (raw-tx 0x020000000218f905443202116524547142bd55b69335dfc4e4c66ff3afaaaab6267b557c4b030000000000000000e0dbdf1039321ab7a2626ca5458e766c6107690b1a1923e075c4f691cc4928ac0000000000000000000220a10700000000002200208730dbfaa29c49f00312812aa12a62335113909711deb8da5ecedd14688188363c5f26010000000022512036f4ff452cb82e505436e73d0a8b630041b71e037e5997290ba1fe0ae7f4d8d56d182500)
    ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
    (raw-block-header 0x0000a02065bc9201b5b5a1d695a18e4d5efe5d52d8ccc4129a2499141d000000000000009160ba7ae5f29f9632dc0cd89f466ee64e2dddfde737a40808ddc147cd82406f18b8486488a127199842cec7)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-tx raw-tx))
  )
    (let ((result (was-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      {tx-index: u3,
      tree-depth: u2,
      hashes: (list 0x3313f803502a6f9a89ac09ff9e8f9d8032aa7c35cc6d1679487622e944c8ccb8 0xc4e620f495d8a30d8d919fc148fe55c8873b4aefe43116bc6ef895aa51572215)}
    )))
    (asserts! (is-eq result (ok txid)) (err "expected txid"))
    (ok true))
  )
)


;; @name verify segwit transaction where OP_RETURN is in output[0]
;; arbitrary segwit transaction
(define-public (test-was-tx-mined-internal-2)
  (let (
    (do-test (prepare))
    (burnchain-block-height u2431459)
    (txid 0x0edafd2b2e9374ede142d1b60f884b47aa7a4ae0a5d46aa9c1d63d2e8e27087d)
    (raw-tx 0x0200000001cbab643067979ec7a7c74bf49af775b20203df78e31b83b2d25510fe5897872c0000000000feffffff02b0631d0000000000160014f55fa4fafee59cccde7d6204029d388480d354b6ce32599300000000160014cc9957eaabf54d9fa7d1c0ae64bd0f95e0bd0cdfe2192500)
    ;; block id: 000000004daafb5977a88c7111da740e77cf6dd5a417f343ed01374676266c36
    (raw-block-header 0x000000207277c3a739ad34a3873a3c9d755f0766e918f4b37adcfe455d079b93000000000bad83579d633d37aa1e2bb725b8a5bad35509374454f1adad8a4de140066d74dbf64e64ffff001d6616bfe2)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-tx raw-tx))
  )
    ;; prepare
    (let ((result (was-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      {tx-index: u8,
      tree-depth: u7,
      hashes: (list 0xbcbc1fe72ca5d67f74099ac4f851cd6a266d2a42fa6c9a6244b11adf6a2f13fb 0x4348ff70e7b2132e0b6044f960ec25a5f7966f5d6182827c9359039a7654218e 0x6fed856ef1075c15a1318eeb512349ceb6a5115953990369c9cb03d65a550468 0xfcaccdf24d540b6ec02568efaefc5df5b04e249ecaaf95a9170c9b72e7b8f46d 0x7d45568289180def6b91cdf6f89c692f3798872948b582a9f6fd5cc471cb67e0 0xe5fefbaf926e706c4ef331d172dcb589dfd6b997bee4ba6ddee4c7c6e2918549 0x097ae87e24dae74bb00a2bfe0aa3c14537ce04b048285ce69d98301bd9ddee8d)}
    )))
    (asserts! (is-eq result (ok txid)) (err "expected txid"))
    (ok true))
  )
)



;; @name verify segwit transaction where OP_RETURN is in output[0]
;; arbitrary segwit transaction
(define-public (test-was-tx-mined-internal-3)
  (let (
    (do-test (prepare))
    (burnchain-block-height u2431567)
    (txid 0x2fd0308a0bca2f4ea40fe93a19be976a40b2d5e0df08df1dd991b4df31a563fc)
    (raw-tx 0x02000000017d406bb6466e0da97778f55ece77ab6becc415c930dbe618e81e8dae53ba914400000000171600143e8d4581104393d916566886ae01e26be8f8975afeffffff0276410300000000001600143d5f37543d2916547fe9b1242322b22f6e46d6929c9291d8000000001600145b3298860caeb3302f09e58b7cc3cf58d0a674044e1a2500)
    ;; block id: 00000000096ae97d41a543592c3680477444acdc86c877aeb4832744691cb94b
    (raw-block-header 0x000000208af1a70ab2ed062c7ac53eb56b053498db50f0d9c41f0dc8a5efcb1b000000007b64b9e16eb97b1fb32977aa00e2cb7418856b1e794e232be4f3b4b0512cb31256845064ffff001dc3cdbab0)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-wtx raw-tx false))
  )

   (let ((result (was-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      {tx-index: u1,
      tree-depth: u7,
      hashes: (list 0x6ef3bf4c1eab5389170584545683660fa601f38f1216bb6357a9b01560a8f884 0x33274cc92f8b980272688e01114cc2944fb661d1aa3a658c7d29675a46a4d5ad 0x1172bf0943aad7bc580aaab5f5d356b1c172f11c297ccf0077515309906352f2 0x2af4fd00ac79b65c0c508fbf44c22d1cf5acb084770079a94bd72ac816cfceb8 0xed4ca325a1800f0dfb2ab9d63761ecb358c014424e684c820d0d87ace45474a1 0xd3292e0e550420e500f29663dfc8ef632dbcb119c8a1ddf49aa3d32ecad83084 0x6369b65eea600edbd69b56386be9269f9662ca3f384a0ca21922ac03d2936102)}
    )))
    (asserts! (is-eq result (ok txid)) (err "expected txid"))
    (ok true))
  )
)

;; @name verify transaction where there is only the coinbase transaction.
(define-public (test-was-tx-mined-internal-4)
  (let (
    (do-test (prepare))
    (burnchain-block-height u2431619)
    (txid 0xc770364da721e34eeb1a67f09c986fa5e4f13f9819df727e604691f42f5340a1)
    (raw-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff2503831a250000000000000000000000000000000002000000000000073c7500000000000000ffffffff02be402500000000001976a91455a2e914aeb9729b4cd265248cb67a865eae95fd88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf900000000)
    ;; block id:
    (raw-block-header 0x00c0c8306c887f5b2248021d1a6662aa684ca46975a21685800192b3f4e5c8b400000000a140532ff49146607e72df19983ff1e4a56f989cf0671aeb4ee321a74d3670c75c545164695a20192b1ab0c7)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-tx raw-tx))
  )

  (let ((result (was-tx-mined-compact
          burnchain-block-height
          raw-tx
          raw-block-header
          {tx-index: u0,
          tree-depth: u1,
          hashes: (list)}
        )))
    (asserts! (is-eq result (ok txid)) (err "expected txid"))
    (ok true))
  )
)


;; @name OP_RETURN is too large. Fails to parse transaction
(define-public (test-was-tx-mined-internal-5)
  (let (
    (do-test (prepare))
    (burnchain-block-height u2430921)
    (txid 0xe2798f96e3584be98f0b6eb6833dbf8284f95c4bb183f425bf409eb3ecc4bf6b)
    (raw-tx 0x01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff1b03c917250477664664004000009be40b0000084d617261636f726500000000030000000000000000266a24aa21a9edb675067096401108d0bd081d693fb4adae204ea41a2c444ad79826a2d9f0bb250000000000000000fd80017b226964223a6e756c6c2c22726573756c74223a7b2268617368223a2239346562366639633664633130396239646630396333306237616561613065383538656165626536343831346138363036383962383065633931313634383864222c22636861696e6964223a312c2270726576696f7573626c6f636b68617368223a2232663566306161663139633139623138313433333839663864643330353234323539323937393137613562396330613864353432366362323233373731336364222c22636f696e6261736576616c7565223a3632353030303030302c2262697473223a223230376666666666222c22686569676874223a3437382c225f746172676574223a2230303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030666666663766222c226d65726b6c655f73697a65223a312c226d65726b6c655f6e6f6e6365223a323539363939363136327d2c226572726f72223a6e756c6c7db87a2500000000001976a914bb94b2b8ce1719201bf0346d79ee0f60c9d2700088ac00000000)
    ;; block id: 000000000000000011958fb8368d946487bde267f7cb78256ede44ec14e38d87
    (raw-block-header 0x00004020070e3e8245969a60d47d780670d9e05dbbd860927341dda51d000000000000007ecc2f605412dddfe6e5c7798ec114004e6eda96f7045baf653c26ded334cfe27766466488a127199541c0a6)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-tx raw-tx))
  )

  (let ((result (was-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      {tx-index: u0,
      tree-depth: u2,
      hashes: (list 0x3d52480061d7634fa8060430cf86d8de3f577499a2056f5ff80cc36918a78dcc 0x41dd33b4cffe074cc8263f98da7c81006521eb2cc8712028fa491efed619cffb)}
      )))
    (asserts! (is-eq result (ok txid)) (err "expected txid"))
    (ok true))
  )
)



;; @name verify segwit transaction where OP_RETURN is in output[1]
;; arbitrary segwit transaction
(define-public (test-was-tx-mined-internal-6)
  (let (
    (do-test (prepare))
    (burnchain-block-height u2431087)
    (txid 0x3b3a7a31c949048fabf759e670a55ffd5b9472a12e748b684db5d264b6852084)
    (raw-tx 0x020000000218f905443202116524547142bd55b69335dfc4e4c66ff3afaaaab6267b557c4b030000000000000000e0dbdf1039321ab7a2626ca5458e766c6107690b1a1923e075c4f691cc4928ac0000000000000000000220a10700000000002200208730dbfaa29c49f00312812aa12a62335113909711deb8da5ecedd14688188363c5f26010000000022512036f4ff452cb82e505436e73d0a8b630041b71e037e5997290ba1fe0ae7f4d8d56d182500)
    ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
    (raw-block-header 0x0000a02065bc9201b5b5a1d695a18e4d5efe5d52d8ccc4129a2499141d000000000000009160ba7ae5f29f9632dc0cd89f466ee64e2dddfde737a40808ddc147cd82406f18b8486488a127199842cec7)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-tx raw-tx))
  )
    ;; prepare

    (let ((result (was-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      {tx-index: u3,
      tree-depth: u2,
      hashes: (list 0x3313f803502a6f9a89ac09ff9e8f9d8032aa7c35cc6d1679487622e944c8ccb8 0xc4e620f495d8a30d8d919fc148fe55c8873b4aefe43116bc6ef895aa51572215)}
    )))
    (asserts! (is-eq result (ok txid)) (err "expected txid"))
    (ok true))
  )
)

;; @name verify segwit transaction where merkle proof is wrong
;; arbitrary segwit transaction
(define-public (test-was-tx-mined-internal-7)
  (let (
    (do-test (prepare))
    (burnchain-block-height u2431087)
    (txid 0x3b3a7a31c949048fabf759e670a55ffd5b9472a12e748b684db5d264b6852084)
    (raw-tx 0x020000000218f905443202116524547142bd55b69335dfc4e4c66ff3afaaaab6267b557c4b030000000000000000e0dbdf1039321ab7a2626ca5458e766c6107690b1a1923e075c4f691cc4928ac0000000000000000000220a10700000000002200208730dbfaa29c49f00312812aa12a62335113909711deb8da5ecedd14688188363c5f26010000000022512036f4ff452cb82e505436e73d0a8b630041b71e037e5997290ba1fe0ae7f4d8d56d182500)
    ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
    (raw-block-header 0x0000a02065bc9201b5b5a1d695a18e4d5efe5d52d8ccc4129a2499141d000000000000009160ba7ae5f29f9632dc0cd89f466ee64e2dddfde737a40808ddc147cd82406f18b8486488a127199842cec7)
    (parsed-block-header (parse-block-header raw-block-header))
    (parsed-tx (parse-tx raw-tx))
  )
    ;; prepare

    (let ((result (was-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      {tx-index: u3,
      tree-depth: u2,
      hashes: (list 0x3313f803502a6f9a89ac09ff9e8f9d8032aa7c35cc6d1679487622e944c8ccb8 0x3313f803502a6f9a89ac09ff9e8f9d8032aa7c35cc6d1679487622e944c8ccb8)}
    )))
    (asserts! (is-eq result (err ERR-INVALID-MERKLE-PROOF)) (err "expected ERR-INVALID-MERKLE-PROOF"))
    (ok true))
  )
)

;; ;; @name verify transaction with wrong block height
;; ;; arbitrary segwit transaction
;; (define-public (test-was-tx-mined-internal-8)
;;   (let (
;;     (burnchain-block-height u1)
;;     (txid 0x3b3a7a31c949048fabf759e670a55ffd5b9472a12e748b684db5d264b6852084)
;;     (raw-tx 0x020000000218f905443202116524547142bd55b69335dfc4e4c66ff3afaaaab6267b557c4b030000000000000000e0dbdf1039321ab7a2626ca5458e766c6107690b1a1923e075c4f691cc4928ac0000000000000000000220a10700000000002200208730dbfaa29c49f00312812aa12a62335113909711deb8da5ecedd14688188363c5f26010000000022512036f4ff452cb82e505436e73d0a8b630041b71e037e5997290ba1fe0ae7f4d8d56d182500)
;;     ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
;;     (raw-block-header 0x0000a02065bc9201b5b5a1d695a18e4d5efe5d52d8ccc4129a2499141d000000000000009160ba7ae5f29f9632dc0cd89f466ee64e2dddfde737a40808ddc147cd82406f18b8486488a127199842cec7)
;;     (parsed-block-header (parse-block-header raw-block-header))
;;     (parsed-tx (parse-tx raw-tx))
;;   )
;;     (let ((result (was-tx-mined-compact
;;       burnchain-block-height
;;       raw-tx
;;       raw-block-header
;;       {tx-index: u3,
;;       tree-depth: u2,
;;       hashes: (list 0x3313f803502a6f9a89ac09ff9e8f9d8032aa7c35cc6d1679487622e944c8ccb8 0xc4e620f495d8a30d8d919fc148fe55c8873b4aefe43116bc6ef895aa51572215)}
;;     )))
;;     (asserts! (is-eq result (err ERR-HEADER-HEIGHT-MISMATCH)) (err "expected ERR-HEADER-HEIGHT-MISMATCH"))
;;     (ok true))
;;   )
;; )

;; @name verify segwit transaction with left over data
(define-public (test-parse-tx)
  (let (
    (burnchain-block-height u2431087)
    ;; 0x3b3a7a31c949048fabf759e670a55ffd5b9472a12e748b684db5d264b6852084 + 0xffffff
    (raw-tx 0x020000000218f905443202116524547142bd55b69335dfc4e4c66ff3afaaaab6267b557c4b030000000000000000e0dbdf1039321ab7a2626ca5458e766c6107690b1a1923e075c4f691cc4928ac0000000000000000000220a10700000000002200208730dbfaa29c49f00312812aa12a62335113909711deb8da5ecedd14688188363c5f26010000000022512036f4ff452cb82e505436e73d0a8b630041b71e037e5997290ba1fe0ae7f4d8d56d182500ffffff)
    ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
  )
    (let ((result (parse-tx raw-tx)))
    (asserts! (is-eq result (err ERR-LEFTOVER-DATA)) (err "expected ERR-LEFTOVER-DATA"))
    (ok true))
  )
)

;; ;; @name verify block header with invalid block
;; (define-public (test-verify-block-header)
;;  (let (
;;     (burnchain-block-height u0)
;;     ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
;;     (raw-block-header 0x0000a02065bc9201b5b5a1d695a18e4d5efe5d52d8ccc4129a2499141d000000000000009160ba7ae5f29f9632dc0cd89f466ee64e2dddfde737a40808ddc147cd82406f18b8486488a127199842cec7)
;;   )
;;     (let ((result (verify-block-header raw-block-header burnchain-block-height)))
;;     (asserts! (is-eq result false) (err "expected invalid block header"))
;;     (ok true))
;;   )
;; )
