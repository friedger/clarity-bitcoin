(define-constant test-contract-principal (as-contract tx-sender))
(define-constant zero-address 'SP000000000000000000002Q6VF78)

(define-public (add-burnchain-block-header-hash (burn-height uint) (header (buff 80)))
  (contract-call? .clarity-bitcoin mock-add-burnchain-block-header-hash burn-height (contract-call? .clarity-bitcoin reverse-buff32 (sha256 (sha256 header))))
)


(define-public (prepare)
	(begin
    ;; 1
    (unwrap-panic (add-burnchain-block-header-hash u2431087 0x0000a02065bc9201b5b5a1d695a18e4d5efe5d52d8ccc4129a2499141d000000000000009160ba7ae5f29f9632dc0cd89f466ee64e2dddfde737a40808ddc147cd82406f18b8486488a127199842cec7))
    ;; 2
    (unwrap-panic (add-burnchain-block-header-hash u2431459 0x000000207277c3a739ad34a3873a3c9d755f0766e918f4b37adcfe455d079b93000000000bad83579d633d37aa1e2bb725b8a5bad35509374454f1adad8a4de140066d74dbf64e64ffff001d6616bfe2))
    ;; 3
    (unwrap-panic (add-burnchain-block-header-hash u2431567 0x000000208af1a70ab2ed062c7ac53eb56b053498db50f0d9c41f0dc8a5efcb1b000000007b64b9e16eb97b1fb32977aa00e2cb7418856b1e794e232be4f3b4b0512cb31256845064ffff001dc3cdbab0))
    ;; 4
    (unwrap-panic (add-burnchain-block-header-hash u2431619 0x00c0c8306c887f5b2248021d1a6662aa684ca46975a21685800192b3f4e5c8b400000000a140532ff49146607e72df19983ff1e4a56f989cf0671aeb4ee321a74d3670c75c545164695a20192b1ab0c7))
    ;; 5
    (unwrap-panic (add-burnchain-block-header-hash u2431567 0x000000208af1a70ab2ed062c7ac53eb56b053498db50f0d9c41f0dc8a5efcb1b000000007b64b9e16eb97b1fb32977aa00e2cb7418856b1e794e232be4f3b4b0512cb31256845064ffff001dc3cdbab0))
    ;; 6
    (unwrap-panic (add-burnchain-block-header-hash u2430921 0x00004020070e3e8245969a60d47d780670d9e05dbbd860927341dda51d000000000000007ecc2f605412dddfe6e5c7798ec114004e6eda96f7045baf653c26ded334cfe27766466488a127199541c0a6))
    ;; 7
    (unwrap-panic (add-burnchain-block-header-hash u2431087 0x0000a02065bc9201b5b5a1d695a18e4d5efe5d52d8ccc4129a2499141d000000000000009160ba7ae5f29f9632dc0cd89f466ee64e2dddfde737a40808ddc147cd82406f18b8486488a127199842cec7))
		;; 8
    (unwrap-panic (add-burnchain-block-header-hash u895331 0x000000289ae31c64a91ed66c9e10338273dbc6fb85718973060c01000000000000000000ec632cf19fcf973835da9999ca8237bb85ce194b20332b1b32e188290284348385891868ed5c0217997b9d99))
		(ok true)
	)
)

;; @name parse raw coinbase transaction
;; @no-prepare
;; arbitrary coinbase transaction
(define-public (test-parse-raw-coinbase-transaction)
  (let (
    ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
      (raw-coinbase-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff23036f18250418b848644d65726d61696465722046545721010000686d20000000000000ffffffff02edfe250000000000160014c035e789d9efffa10aa92e93f48f29b8cfb224c20000000000000000266a24aa21a9ed260ac9521c6b0c1b09e438319b5cb3377911764f156e44da61b1ab820f75104c00000000)
      (parsed-coinbase-tx (contract-call? .clarity-bitcoin parse-tx raw-coinbase-tx))
      (ins (list { outpoint: { hash: 0x0000000000000000000000000000000000000000000000000000000000000000, index: u4294967295},
        scriptSig: 0x036f18250418b848644d65726d61696465722046545721010000686d20000000000000, sequence: u4294967295}))
      (outs (list {scriptPubKey: 0x0014c035e789d9efffa10aa92e93f48f29b8cfb224c2, value: u2490093}
        {scriptPubKey: 0x6a24aa21a9ed260ac9521c6b0c1b09e438319b5cb3377911764f156e44da61b1ab820f75104c, value: u0}))
      (expected {version: u2, ins: ins, outs: outs, locktime: u0})
    )
    (ok (asserts! (is-eq parsed-coinbase-tx (ok expected)) (err parsed-coinbase-tx)))
  )
)

;; @name verify segwit transaction where OP_RETURN is in output[1]
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-1)
  (let (
    (burnchain-block-height u2431087)
    ;; txid: 3b3a7a31c949048fabf759e670a55ffd5b9472a12e748b684db5d264b6852084
    (raw-tx 0x0200000000010218f905443202116524547142bd55b69335dfc4e4c66ff3afaaaab6267b557c4b030000000000000000e0dbdf1039321ab7a2626ca5458e766c6107690b1a1923e075c4f691cc4928ac0000000000000000000220a10700000000002200208730dbfaa29c49f00312812aa12a62335113909711deb8da5ecedd14688188363c5f26010000000022512036f4ff452cb82e505436e73d0a8b630041b71e037e5997290ba1fe0ae7f4d8d50140a50417be5a056f63e052294cb20643f83038d5cd90e2f90c1ad3f80180026cb99d78cd4480fadbbc5b9cad5fb2248828fb21549e7cb3f7dbd7aefd2d541bd34f0140acde555b7689eae41d5ccf872bb32a270893bdaa1defc828b76c282f6c87fc387d7d4343c5f7288cfd9aa5da0765c7740ca97e44a0205a1abafa279b530d5fe36d182500)
    ;; txid: f1bb118d6663640d6571d08ee36ffff78130c0a6a959e69929f952e745e54050
    (raw-coinbase-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff23036f18250418b848644d65726d61696465722046545721010000686d20000000000000ffffffff02edfe250000000000160014c035e789d9efffa10aa92e93f48f29b8cfb224c20000000000000000266a24aa21a9ed260ac9521c6b0c1b09e438319b5cb3377911764f156e44da61b1ab820f75104c00000000)
    ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
    (raw-block-header 0x0000a02065bc9201b5b5a1d695a18e4d5efe5d52d8ccc4129a2499141d000000000000009160ba7ae5f29f9632dc0cd89f466ee64e2dddfde737a40808ddc147cd82406f18b8486488a127199842cec7)
    (witness-merkle-root 0x15424423c2614c23aceec8d732b5330c21ff3a306f52243fbeef47a192c65c86)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    (parsed-block-header (contract-call? .clarity-bitcoin parse-block-header raw-block-header))
    (parsed-tx (contract-call? .clarity-bitcoin parse-wtx raw-tx false))
  )

    (let ((result (contract-call? .clarity-bitcoin was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u3
      u2
      (list 0xb2d7ec769ce60ebc0c8fb9cc37f0ad7481690fc176b82c8d17d3c05da80fea6b 0x122f3217765b6e8f3163f6725d4aa3d303e4ffe4b99a5e85fb4ff91a026c17a8)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0x5f4a8858a112953111d5f94605c4dd8d04690eeeb9ffe2f435475d95943f2f3f 0x3348bf81aae79941662a902206b3ed2d285713668ab134c9e113548daea596fc)
    )))
    (asserts! (is-eq result (ok 0xc62ea13f720175da9c93507db2b586b1d0a84faea386bf448a5bc470c37d1104)) (err "expected txid"))
    (ok true))
  )
)

;; @name verify segwit transaction where OP_RETURN is in output[0]
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-2)
  (let (
    (burnchain-block-height u2431459)
    ;; txid: 0edafd2b2e9374ede142d1b60f884b47aa7a4ae0a5d46aa9c1d63d2e8e27087d
    (raw-tx 0x02000000000101cbab643067979ec7a7c74bf49af775b20203df78e31b83b2d25510fe5897872c0000000000feffffff02b0631d0000000000160014f55fa4fafee59cccde7d6204029d388480d354b6ce32599300000000160014cc9957eaabf54d9fa7d1c0ae64bd0f95e0bd0cdf0247304402200f17b4dfafedf598db8c48551efc8cce14de071ef86a0c7494d593e7346856c702207f96c3382ed4ed855bc86ac5a6df2e283c1b06276176cae590abdcd6f7c491bf012102276dc68fca4dae0eedbd5b9d7b36baccaff56b777d103d169ec31ce25f04fd14e2192500)
    ;; block id: 000000004daafb5977a88c7111da740e77cf6dd5a417f343ed01374676266c36
    (raw-block-header 0x000000207277c3a739ad34a3873a3c9d755f0766e918f4b37adcfe455d079b93000000000bad83579d633d37aa1e2bb725b8a5bad35509374454f1adad8a4de140066d74dbf64e64ffff001d6616bfe2)
    (witness-merkle-root 0x9a0f41eac348c25620b76aa15f771a7972638e8423ce590cdbe1432c4f5726c0)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    ;; txid: 28f35a9c67a275e1cf8678c3f030f005b4c85ff8fcbf1742035ec39ebbdb5164
    (raw-coinbase-tx 0x01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff1603e319251300000062696e67626f6e67210001000000ffffffff02bbb329000000000017a9148746e880ec2156d6b527e1962456cff7720695df870000000000000000266a24aa21a9edcbc79776b99d0cc0c2d597ce40c92958ba98f3adb6e59ed27c3a03d1c1703e1c00000000)
    (parsed-block-header (contract-call? .clarity-bitcoin parse-block-header raw-block-header))
    (parsed-tx (contract-call? .clarity-bitcoin parse-wtx raw-tx false))
  )
    (let ((result (contract-call? .clarity-bitcoin was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u8
      u7
      (list 0xbcbc1fe72ca5d67f74099ac4f851cd6a266d2a42fa6c9a6244b11adf6a2f13fb 0xec7eee1209489f80c4a5df2a90f26ee0ba0838be6f00442e3e0ab9d095865b45 0x0ddfb056b3e566ac3b376a940b9eff66a77296ec200f427b158f1700b2a32398 0x922b21d35cda111feeb04cd69d2fa78312fd34614d34c4fbfd204730b6ef013f 0xcf4c5ecd88374f44ae63ba87f96ef20e0330a247434c219ce8f8fdbc7ace4401 0x04889c3c93e70474fe0724f5270e26d91c974fa7b642703286903350480e2281 0x762dd8d1161d1d32a79c98f6273b6feb50405446e861db0f32c7403a8bb310b2)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0x012e8988aa58e53ac700c22257237716f642aea5ad45c3f6420eb010bf2b37f9 0x10b71df80cc37bd92c746690a980a7f4187e6dbf8b973ac938f1b1b9d1ef25b6 0x897a09fa66156b753366b38236fd40fe7920db114722b3d7762826bf4930750c 0x2cf51c5e81f70b72c37fd8eccd8d3446c7c69c4d568acd23c9949c25bc1d3fb4 0x7d45568289180def6b91cdf6f89c692f3798872948b582a9f6fd5cc471cb67e0 0xe5fefbaf926e706c4ef331d172dcb589dfd6b997bee4ba6ddee4c7c6e2918549 0x097ae87e24dae74bb00a2bfe0aa3c14537ce04b048285ce69d98301bd9ddee8d)
    )))
    (asserts! (is-eq result (ok 0xfea94d1e37eee8642ebbd6f5b43f6d092d9ac197f921f4598117a833dbe55b68)) (err "expected txid"))
    (ok true))
  )
)

;; @name verify segwit transaction where OP_RETURN is in output[0]
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-3)
  (let (
    (burnchain-block-height u2431567)
    ;; txid: 2fd0308a0bca2f4ea40fe93a19be976a40b2d5e0df08df1dd991b4df31a563fc
    (raw-tx 0x020000000001017d406bb6466e0da97778f55ece77ab6becc415c930dbe618e81e8dae53ba914400000000171600143e8d4581104393d916566886ae01e26be8f8975afeffffff0276410300000000001600143d5f37543d2916547fe9b1242322b22f6e46d6929c9291d8000000001600145b3298860caeb3302f09e58b7cc3cf58d0a6740402463043021f53943d5951726d73a952473b49aa44dde64446f106749806d6478b0bdc053102200863a4f25914f3032afa8549f329962e8ecc7c575a1aefc51102a566ff5ece70012103742fe8a7244ab8384b3d533eb19138e2758c2b7a2e351c9ec2b8912cf4e046c24e1a2500)
    ;; block id: 00000000096ae97d41a543592c3680477444acdc86c877aeb4832744691cb94b
    (raw-block-header 0x000000208af1a70ab2ed062c7ac53eb56b053498db50f0d9c41f0dc8a5efcb1b000000007b64b9e16eb97b1fb32977aa00e2cb7418856b1e794e232be4f3b4b0512cb31256845064ffff001dc3cdbab0)
    (witness-merkle-root 0xb2ea7fb39beae6b5a225c85cb7087561909e1d17bba74de3592a3c1da3944983)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    ;; txid: 84f8a86015b0a95763bb16128ff301a60f668356548405178953ab1e4cbff36e
    (raw-coinbase-tx 0x01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff32034f1a2500045684506404c862b40c0c11c14a6400000000000000000a636b706f6f6c0e2f6d696e65642062792072736b2fffffffff0317ea2b00000000001976a914ec2f9ffaba0d68ea6bd7c25cedfe2ae710938e6088ac0000000000000000266a24aa21a9ede2ee16ef0a8c0fd6ccb8c78f297199f0f143629121801c46b1e1487c0123cb4b00000000000000002a6a52534b424c4f434b3acb9b4841f625100fb87055003991835f3183bff7668865e93e1f1118003a492d00000000)
    (parsed-block-header (contract-call? .clarity-bitcoin parse-block-header raw-block-header))
    (parsed-tx (contract-call? .clarity-bitcoin parse-wtx raw-tx false))
  )

    (let ((result (contract-call? .clarity-bitcoin was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u1
      u7
      (list 0x0000000000000000000000000000000000000000000000000000000000000000 0x71f824a016ae0f58a01cb8a4aafb910c6013666640f43b745adc87dcc9118a66 0x3efcbcef748b6b46ce25fc94d455555851322f9bcbf36de02500492dacc8fcfa 0xbca0973353bed064af7388d48969f23b0dc65d8cb1c8eaae95890b7c08a39914 0x84211c0f3a64e0fab33d1ab9d537a60adab81bcb681f1297901aad5566683e56 0x8527cd4ff222ff5010726219744a19522e2d016873d4a8ca3bfa984f32cf7355 0x83fbd3b472c7e7285ad25fd40edaf658acef8756aecf32a115d98fd07d006af9)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0xfc63a531dfb491d91ddf08dfe0d5b2406a97be193ae90fa44e2fca0b8a30d02f 0x33274cc92f8b980272688e01114cc2944fb661d1aa3a658c7d29675a46a4d5ad 0x1172bf0943aad7bc580aaab5f5d356b1c172f11c297ccf0077515309906352f2 0x2af4fd00ac79b65c0c508fbf44c22d1cf5acb084770079a94bd72ac816cfceb8 0xed4ca325a1800f0dfb2ab9d63761ecb358c014424e684c820d0d87ace45474a1 0xd3292e0e550420e500f29663dfc8ef632dbcb119c8a1ddf49aa3d32ecad83084 0x6369b65eea600edbd69b56386be9269f9662ca3f384a0ca21922ac03d2936102)
    )))
    (asserts! (is-eq result (ok 0xbf986c2f7c53f7fc6f87ec605d4e4ff58aa1f4558fa4bfa7bc692d64277168da)) (err "expected txid"))
    (ok true))
  )
)

;; @name verify segwit transaction where the incorrect proof is provided and only the first transaction is given. should fail
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-4)
  (let (
    (burnchain-block-height u2431619)
    ;; txid: c770364da721e34eeb1a67f09c986fa5e4f13f9819df727e604691f42f5340a1
    (raw-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff2503831a250000000000000000000000000000000002000000000000073c7500000000000000ffffffff02be402500000000001976a91455a2e914aeb9729b4cd265248cb67a865eae95fd88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf900000000)
    ;; block id:
    (raw-block-header 0x00c0c8306c887f5b2248021d1a6662aa684ca46975a21685800192b3f4e5c8b400000000a140532ff49146607e72df19983ff1e4a56f989cf0671aeb4ee321a74d3670c75c545164695a20192b1ab0c7)
    (witness-merkle-root 0x0000000000000000000000000000000000000000000000000000000000000000)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    ;; txid: c770364da721e34eeb1a67f09c986fa5e4f13f9819df727e604691f42f5340a1
    (raw-coinbase-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff2503831a250000000000000000000000000000000002000000000000073c7500000000000000ffffffff02be402500000000001976a91455a2e914aeb9729b4cd265248cb67a865eae95fd88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf900000000)
    (parsed-block-header (contract-call? .clarity-bitcoin parse-block-header raw-block-header))
    (parsed-tx (contract-call? .clarity-bitcoin parse-wtx raw-tx false))
  )

    (match (contract-call? .clarity-bitcoin was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u0
      u1
      (list )
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0x12b32c51b0b4f3e42b234e791e6b851874cbe200aa7729b31f7bb96ee1b9647b)
    )
      ok-res (err u1)
      err-res (if (is-eq err-res ERR-PROOF-TOO-SHORT) (ok true) (err err-res))
    )
  )
)


;; @name verify segwit transaction where the incorrect wproof with zeros only
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-5)
  (let (
  (burnchain-block-height u2431567)
    ;; txid: 2fd0308a0bca2f4ea40fe93a19be976a40b2d5e0df08df1dd991b4df31a563fc
    (raw-tx 0x020000000001017d406bb6466e0da97778f55ece77ab6becc415c930dbe618e81e8dae53ba914400000000171600143e8d4581104393d916566886ae01e26be8f8975afeffffff0276410300000000001600143d5f37543d2916547fe9b1242322b22f6e46d6929c9291d8000000001600145b3298860caeb3302f09e58b7cc3cf58d0a6740402463043021f53943d5951726d73a952473b49aa44dde64446f106749806d6478b0bdc053102200863a4f25914f3032afa8549f329962e8ecc7c575a1aefc51102a566ff5ece70012103742fe8a7244ab8384b3d533eb19138e2758c2b7a2e351c9ec2b8912cf4e046c24e1a2500)
    ;; block id: 00000000096ae97d41a543592c3680477444acdc86c877aeb4832744691cb94b
    (raw-block-header 0x000000208af1a70ab2ed062c7ac53eb56b053498db50f0d9c41f0dc8a5efcb1b000000007b64b9e16eb97b1fb32977aa00e2cb7418856b1e794e232be4f3b4b0512cb31256845064ffff001dc3cdbab0)
    (witness-merkle-root 0xb2ea7fb39beae6b5a225c85cb7087561909e1d17bba74de3592a3c1da3944983)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    ;; txid: 84f8a86015b0a95763bb16128ff301a60f668356548405178953ab1e4cbff36e
    (raw-coinbase-tx 0x01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff32034f1a2500045684506404c862b40c0c11c14a6400000000000000000a636b706f6f6c0e2f6d696e65642062792072736b2fffffffff0317ea2b00000000001976a914ec2f9ffaba0d68ea6bd7c25cedfe2ae710938e6088ac0000000000000000266a24aa21a9ede2ee16ef0a8c0fd6ccb8c78f297199f0f143629121801c46b1e1487c0123cb4b00000000000000002a6a52534b424c4f434b3acb9b4841f625100fb87055003991835f3183bff7668865e93e1f1118003a492d00000000)
    (parsed-block-header (contract-call? .clarity-bitcoin parse-block-header raw-block-header))
    (parsed-tx (contract-call? .clarity-bitcoin parse-wtx raw-tx false))
  )

    (let ((result (contract-call? .clarity-bitcoin was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u1
      u7
      (list 0x0000000000000000000000000000000000000000000000000000000000000000 0x0000000000000000000000000000000000000000000000000000000000000000 0x0000000000000000000000000000000000000000000000000000000000000000 0x0000000000000000000000000000000000000000000000000000000000000000 0x0000000000000000000000000000000000000000000000000000000000000000 0x0000000000000000000000000000000000000000000000000000000000000000 0x0000000000000000000000000000000000000000000000000000000000000000)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0xfc63a531dfb491d91ddf08dfe0d5b2406a97be193ae90fa44e2fca0b8a30d02f 0x33274cc92f8b980272688e01114cc2944fb661d1aa3a658c7d29675a46a4d5ad 0x1172bf0943aad7bc580aaab5f5d356b1c172f11c297ccf0077515309906352f2 0x2af4fd00ac79b65c0c508fbf44c22d1cf5acb084770079a94bd72ac816cfceb8 0xed4ca325a1800f0dfb2ab9d63761ecb358c014424e684c820d0d87ace45474a1 0xd3292e0e550420e500f29663dfc8ef632dbcb119c8a1ddf49aa3d32ecad83084 0x6369b65eea600edbd69b56386be9269f9662ca3f384a0ca21922ac03d2936102)
    )))
      (asserts! (is-eq result (err ERR-WITNESS-TX-NOT-IN-COMMITMENT)) (err result))
      (ok true)
    )
  )
)

;; @name OP_RETURN is too large. Fails to parse segwit transaction
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-6)
  (let (
    (burnchain-block-height u2430921)
    ;; txid: c770364da721e34eeb1a67f09c986fa5e4f13f9819df727e604691f42f5340a1
    (raw-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff2503831a250000000000000000000000000000000002000000000000073c7500000000000000ffffffff02be402500000000001976a91455a2e914aeb9729b4cd265248cb67a865eae95fd88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf900000000)
    ;; block id: 000000000000000011958fb8368d946487bde267f7cb78256ede44ec14e38d87
    (raw-block-header 0x00004020070e3e8245969a60d47d780670d9e05dbbd860927341dda51d000000000000007ecc2f605412dddfe6e5c7798ec114004e6eda96f7045baf653c26ded334cfe27766466488a127199541c0a6)
    (witness-merkle-root 0x366c4677e2f40e524b773344401f1de980ec9a9cb3453620cd1ff652b9c1d53e)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    ;; txid: e2798f96e3584be98f0b6eb6833dbf8284f95c4bb183f425bf409eb3ecc4bf6b
    (raw-coinbase-tx 0x01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff1b03c917250477664664004000009be40b0000084d617261636f726500000000030000000000000000266a24aa21a9edb675067096401108d0bd081d693fb4adae204ea41a2c444ad79826a2d9f0bb250000000000000000fd80017b226964223a6e756c6c2c22726573756c74223a7b2268617368223a2239346562366639633664633130396239646630396333306237616561613065383538656165626536343831346138363036383962383065633931313634383864222c22636861696e6964223a312c2270726576696f7573626c6f636b68617368223a2232663566306161663139633139623138313433333839663864643330353234323539323937393137613562396330613864353432366362323233373731336364222c22636f696e6261736576616c7565223a3632353030303030302c2262697473223a223230376666666666222c22686569676874223a3437382c225f746172676574223a2230303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030666666663766222c226d65726b6c655f73697a65223a312c226d65726b6c655f6e6f6e6365223a323539363939363136327d2c226572726f72223a6e756c6c7db87a2500000000001976a914bb94b2b8ce1719201bf0346d79ee0f60c9d2700088ac00000000)
    (parsed-block-header (contract-call? .clarity-bitcoin parse-block-header raw-block-header))
    (parsed-tx (contract-call? .clarity-bitcoin parse-wtx raw-tx false))
  )

    (match (contract-call? .clarity-bitcoin was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u2
      u2
      (list 0x060f653adf158c9765994dcc38c2d29c4722b4415e56468aae2908cc26d5b7fc 0x438e9befc51be8d8570386ce9b5050e75ddcd410c92d0e7693b11c82b4c73f2f)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0x3d52480061d7634fa8060430cf86d8de3f577499a2056f5ff80cc36918a78dcc 0x41dd33b4cffe074cc8263f98da7c81006521eb2cc8712028fa491efed619cffb)
    )
      ok-res (err u1)
      err-res (if (is-eq err-res ERR-VARSLICE-TOO-LONG) (ok true) (err err-res))
    )
  )
)

;; @name verify segwit transaction where OP_RETURN is in output[1]
;; arbitrary segwit transaction
(define-public (test-was-wtx-mined-internal-7)
  (let (
    (burnchain-block-height u2431087)
    ;; txid: 3b3a7a31c949048fabf759e670a55ffd5b9472a12e748b684db5d264b6852084
    (raw-tx 0x0200000000010218f905443202116524547142bd55b69335dfc4e4c66ff3afaaaab6267b557c4b030000000000000000e0dbdf1039321ab7a2626ca5458e766c6107690b1a1923e075c4f691cc4928ac0000000000000000000220a10700000000002200208730dbfaa29c49f00312812aa12a62335113909711deb8da5ecedd14688188363c5f26010000000022512036f4ff452cb82e505436e73d0a8b630041b71e037e5997290ba1fe0ae7f4d8d50140a50417be5a056f63e052294cb20643f83038d5cd90e2f90c1ad3f80180026cb99d78cd4480fadbbc5b9cad5fb2248828fb21549e7cb3f7dbd7aefd2d541bd34f0140acde555b7689eae41d5ccf872bb32a270893bdaa1defc828b76c282f6c87fc387d7d4343c5f7288cfd9aa5da0765c7740ca97e44a0205a1abafa279b530d5fe36d182500)
    ;; txid: f1bb118d6663640d6571d08ee36ffff78130c0a6a959e69929f952e745e54050
    (raw-coinbase-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff23036f18250418b848644d65726d61696465722046545721010000686d20000000000000ffffffff02edfe250000000000160014c035e789d9efffa10aa92e93f48f29b8cfb224c20000000000000000266a24aa21a9ed260ac9521c6b0c1b09e438319b5cb3377911764f156e44da61b1ab820f75104c00000000)
    ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
    (raw-block-header 0x0000a02065bc9201b5b5a1d695a18e4d5efe5d52d8ccc4129a2499141d000000000000009160ba7ae5f29f9632dc0cd89f466ee64e2dddfde737a40808ddc147cd82406f18b8486488a127199842cec7)
    (witness-merkle-root 0x15424423c2614c23aceec8d732b5330c21ff3a306f52243fbeef47a192c65c86)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    (parsed-block-header (contract-call? .clarity-bitcoin parse-block-header raw-block-header))
    (parsed-tx (contract-call? .clarity-bitcoin parse-wtx raw-tx false))
  )
    (let ((result (contract-call? .clarity-bitcoin was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u3
      u2
      (list 0xb2d7ec769ce60ebc0c8fb9cc37f0ad7481690fc176b82c8d17d3c05da80fea6b 0x122f3217765b6e8f3163f6725d4aa3d303e4ffe4b99a5e85fb4ff91a026c17a8)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0x5f4a8858a112953111d5f94605c4dd8d04690eeeb9ffe2f435475d95943f2f3f 0x3348bf81aae79941662a902206b3ed2d285713668ab134c9e113548daea596fc)
    )))
    (asserts! (is-eq result (ok 0xc62ea13f720175da9c93507db2b586b1d0a84faea386bf448a5bc470c37d1104)) (err "expected txid"))
    (ok true))
  )
)

;; @name verify segwit transaction where coinbase tx has 44 outputs
(define-public (test-was-wtx-mined-internal-8)
  (let (
    (burnchain-block-height u895331)
    ;; txid: 0f3885e3f721491fc1c5df5ec3378a7f314d15bc7b1a53aa5c82b24f0ce8f6d8
    (raw-tx 0x02000000000101bf0a791c63dde698e90cbe08b9380660aa915af65fd0d0dd6c1e7d044836346100000000171600140f66bf9b851c7246c78b243b3104501a0032a1d2ffffffff0300000000000000001f6a1d0c0000000101700516e89cf3fa48087bd2831e48f560de473f8b1b898f18f600000000000016001420e180ca60ada9fe947ceb64c7aba1cd0e2babbe0c3203000000000017a914ad157f8359fb3ab1b5d9e4574fa8c53e5113d7368702473044022026bb7b3841dd8f545e01e8bcc72976245e1e175968360eed472deab4bd91912502202c47c1dc38886b279e8370105bdc3590c69cc4c2687a79eb60dfc33e3f82166701210294af4e532bdacd81531a9fa89464fccb65050cfd6b3532905dc46d3cbf29c94b00000000)
    ;; txid: 169e09fa993ed0ad1476b2db432765194a0266469b91d9e5efb251f58f70984e
    (raw-coinbase-tx 0x01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff2d0363a90d163c204f4345414e2e58595a203e0f0f3243525f4231000227700e5952b0ccf0cc24a8c40000000000ffffffff2c0000000000000000166a144f434231a430dd4f1600000029000000acd8c71b8b0410000000000017a9141052313d20c9145492dac7dadcb33354ff1071ef870622e1020000000017a9142b636a84e5b12177cd49c687b5a1ebd07fb83fbf8796734602000000002200200aee90d8fd95691d461546eb2ab688d7b1e4413dfcb8485c923a6981bece769de0b6040200000000220020ac11a29a5721e9602e396acd7e5216c9196b7dbb14cf573921c46e6fea38ac093151e70100000000220020d2628cb629f5608ec44ac2324cdd94497fc28f41a7460626b520a04aa17232ffc0259801000000001600146983f7fe983e96dc5b43677fb14822a0755963643c27750100000000160014d192719c5be868068f023b9383b3cbecb6afbb162fd1640100000000220020dc406857cac1b9d3f53c6986acb78e7774c604281076d10d3fc8e873e18df6d087635800000000001976a91412c00ad1271bd4c91e4f8ff11e738c285181399d88aca8f9570000000000160014b327f5cbe636766cd34a36daa417a0bd3f3f2c301f0e47000000000016001404afd9f6e36ba7cadb62133c458a5318f41a33ded1f446000000000017a9141ef31e9bc9ccb532b8c01950727990cca190656a876631320000000000220020e65791d3c340710f7aebf117d1f38e1c5383c1df0345a2082e8ebff945e999468a60310000000000160014100bcb0235295bc6a1b91ed543cc87d9c0c4a6b83dca2e00000000001600148daabc38895ce614a89f2f60c8aa2484c58f2d57cb1a2600000000001600146d095474bec41ccc8ad40f94c74dd25b79b83579d3a42200000000001600147a005ea5478b85f6c730c56c2606edff07949ad6823f1f00000000001600140345e587cb42c201c30e505ea9f6f5fb935876acbcb81b000000000016001472fb714ecb210311655a3da22729ff8626bdea59608c160000000000160014a2d379dbb47a38c9839e9e3a2df292e6255c5d3a1a8815000000000016001465c924de97963d4209528a613d627a5bc72397ed723414000000000017a914278dadd16d1314122e4dde67ff9152a61c3a9f478774831300000000001600148826b6c481b029409c931f8df786c092ccf21469456f130000000000160014e8dc41c47939430293f45747ea47e3325a536ec6511d13000000000017a9147a6d8577087d78c261d9d292ea838c9c623ea71c87e24112000000000022002061a2b0a1d72c46828464e83fd2bd986619691a544ca1b7dea6d7b9f5d4259010273f120000000000160014dd8f9b751054ab03f19ba0d36bf8ca50595e7466b1f3110000000000160014542296c4e9ed1fd643e3b1ddb7ff0022acfd781d8fb3110000000000160014f67490875247efb7314b26d1f0f331b75bb4df65b09f11000000000016001420173973b42d0d9334bd92ca231b65665fb3cb0ef8c11000000000002251202505b1ae10be41185da7c0561fd3f4dc56630e9d49264429046777a778f0ab7e1db7100000000000160014b7e81bc54daaad630b3d8da1c20418ce0aa157ad3b8c100000000000220020b0cb7174384edc43c645a0a44ffbb70d8ecf5d0d9912fc819e2970f89af38f5d3e73100000000000160014f6848b0a9c8408abfe956345e9b1e02eacbe9d58315f100000000000160014c5f79480fc5417e2ba5762e89fbf357828d2c2a0b25b10000000000017a9149f31679a6a7d7c22668bb467ac490e950d74dbdb87a64a1000000000001600141945bdbff512289c7cdcfd7158142f23abe4ea52853810000000000017a91468750c2ae538b335f5ebdcdc95b42b148ebce51487d71d100000000000160014b5f7ede18ab02fd488f21387ed4c93d9746d2eb2821b10000000000017a914e41c245e9565123b7441a2532bb58143d6a71bf687b40810000000000022002087a0ae628cc3a8af31ce2132e4cd85e25aa965642560a0e6c9d410507d422b3274c075010000000017a914413b5901fe4e591c95405fd446b5b002da575bf0870000000000000000266a24aa21a9edb1a2db0eeaa343388018b6c539bdb0944f563a5d5c8d9c231d20dbba88ed0da200000000)
    ;; block id: 00000000000000000001cd83ba4ebc179970c571c67cf680f931ad57f392af93 
    (raw-block-header 0x000000289ae31c64a91ed66c9e10338273dbc6fb85718973060c01000000000000000000ec632cf19fcf973835da9999ca8237bb85ce194b20332b1b32e188290284348385891868ed5c0217997b9d99)
    (witness-merkle-root 0xc585ca76300bd5d5754ac8df404d6cdf2d416032f951843632fcb4b2bd803249)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    (parsed-block-header (contract-call? .clarity-bitcoin parse-block-header raw-block-header))
    (parsed-tx (contract-call? .clarity-bitcoin parse-wtx raw-tx false))
  )
    (let ((result (contract-call? .clarity-bitcoin was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u3456
      u13
      (list 0x611ab69bf8d6ad3f91ac374e8b5f33c7ffbb0da714a0650649955d961fdc0604
   0x1476db2e1773b3b8f2d8eb506d024d0cefb1a7ff174a24afa6f74f6da7bedbde
   0x4e335f7e3f0f89fe72fb22f103795d55a58ce0bec620a54d1619c1e7664bd357
   0xdc8480d5959858825b299bd0217612806b319ba36923b997b6b68c80d4b7d955
   0x08306a5bc8c3b5fe54cf9d1c5c0b8e330128418a6c85debeafa4b78724f5d44a
   0x7a8c8243425ab5bbdf913c65a7315c7cdd1b315cab02e023a188f40be7a67187
   0x7a1021da8ca5c6e398b77692898d404867b005c66e6dcc9925dbb2e3a9f725c9
   0x0756c3bfec8ccc4c09d1aa5e1e8e5f77dfc185e8ea10c6acc125f8877d717db8
   0x60674bf603b472c7758e76bc4fcf47bcb0e4f42c3c848b7f132b69359c411d52
   0x0657e66069cf14740635ec25fd8beeb5e5a2684b4f79a3701bfc7de82c599043
   0xe59fb131f53fd2796fab98c1fea7e26ebc3d33428921f4f239d5ddd53b2bd0f9
   0xf7152964931a80341eaefbfc9fe39c42c94bc23d8b5b6e447c4896b664570f68
   0x102364c7305152af68c7dec80752487b1746fbb4d7dc37b512476f9d4ffb2b54)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0x6f9dd42f32a45fb2208862699a8a3a55f22400e890f51d6759974918793d01ed
   0xe4f2928f30571a9a8e4f61715564c404416d61f12e7c2e5bcd0bde0eeb332b07
   0xc907ef913f71deb472ee69c73a0edc9519461476bec03f9667990acfe4a35bef
   0x91501e6db3906f99b25731579e04a027f676c95de322c353dd0bab2101b6e496
   0x8d0bc08d1a79a283f6d05f6b255e91e721b0bf285b45d7a12c4a15eba75dcc1e
   0xbaab3de115a6262645ed80c65116e9c8d45c3371134c80d4c05562a4d18b8c01
   0x711d45e4727f24ce65342d617c1256c50be0d77472d32bee4a6a7d298894395c
   0x0ad964110d3174605b4a55e13a181bdc68eaa6279f00c00375ae61bce4165fb7
   0x95b1d6f58fd463f2b978db1db3c14672676c2ced1a7b17fc0fa43d9b19f53d41
   0x4014fc658167fe3f222ff71a5600b2be1b21f0088b1350e3d7227f4376a2e933
   0xe27b7eb76fe79487b84213ecf44ba02094de7ed59b38d2bf0e85283ea339944f
   0xa0149080154b3f24992cac558875344b6b72eca71fd8231c93709d325995e15e
   0x3773030efef201607073b272df4eb43ebef20e26cd27b25312a0ee8658760b73)
    )))
    (asserts! (is-eq result (ok 0x5b19d69347d031587951d3a7fd7e143967b743610f876bbd86364e6f5feba796)) (err "expected txid"))
    (ok true))
  )
)



;; @name verify segwit transaction where multisig input
(define-public (test-was-wtx-mined-internal-9)
  (let (
    (burnchain-block-height u895331)
    ;; txid: f00f1c98f7d2e13f3eaeed622f885aca093136b4210fc63e37ffc9dfc171e9ac
    (raw-tx 0x010000000001016205b8748f211693cbe8e83a88b98c13215bc5033b517b0c7c74ecf40a435a660000000000fdffffff02f0e82600000000002200207bb8f5802ae446be4e5f7dde387ca1624faee09a8643a8c16ff87df4235e2584be0db70100000000220020a4751c70bc47e83e27103f484ccb2a6058efed8ec0609e5503fa6e79747243a60400483045022100a6357c6338e6d01ec337cbc4a22fd1cf157058a5f451b5e94255c2259bac77d3022025dabf290c207a7498355d27cecb7f0e7472379fdda2bd7d77361eb9af7a05c601483045022100aa8cb7722d2e58218bcb3b4191c82c897625374e9c98670a80adb99fb4bc541c0220505e77ae803afc29553e380a6b8af2c127666247a076c19225227eb0ab6a58330169522103a8db839a705fbc2eaedf4126b983ff7a9c8deb44965e4e395074ab5f32324d702103ae3522f4b5388462adc283e0e9fcfe650f31af9b50bb48758a7e3807c673fc0c2103c224b8758114b233fbfc39484b4bb34561ba917ccb75414bfba368b9c3ad68a653ae00000000)
    ;; txid: 169e09fa993ed0ad1476b2db432765194a0266469b91d9e5efb251f58f70984e
    (raw-coinbase-tx 0x01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff2d0363a90d163c204f4345414e2e58595a203e0f0f3243525f4231000227700e5952b0ccf0cc24a8c40000000000ffffffff2c0000000000000000166a144f434231a430dd4f1600000029000000acd8c71b8b0410000000000017a9141052313d20c9145492dac7dadcb33354ff1071ef870622e1020000000017a9142b636a84e5b12177cd49c687b5a1ebd07fb83fbf8796734602000000002200200aee90d8fd95691d461546eb2ab688d7b1e4413dfcb8485c923a6981bece769de0b6040200000000220020ac11a29a5721e9602e396acd7e5216c9196b7dbb14cf573921c46e6fea38ac093151e70100000000220020d2628cb629f5608ec44ac2324cdd94497fc28f41a7460626b520a04aa17232ffc0259801000000001600146983f7fe983e96dc5b43677fb14822a0755963643c27750100000000160014d192719c5be868068f023b9383b3cbecb6afbb162fd1640100000000220020dc406857cac1b9d3f53c6986acb78e7774c604281076d10d3fc8e873e18df6d087635800000000001976a91412c00ad1271bd4c91e4f8ff11e738c285181399d88aca8f9570000000000160014b327f5cbe636766cd34a36daa417a0bd3f3f2c301f0e47000000000016001404afd9f6e36ba7cadb62133c458a5318f41a33ded1f446000000000017a9141ef31e9bc9ccb532b8c01950727990cca190656a876631320000000000220020e65791d3c340710f7aebf117d1f38e1c5383c1df0345a2082e8ebff945e999468a60310000000000160014100bcb0235295bc6a1b91ed543cc87d9c0c4a6b83dca2e00000000001600148daabc38895ce614a89f2f60c8aa2484c58f2d57cb1a2600000000001600146d095474bec41ccc8ad40f94c74dd25b79b83579d3a42200000000001600147a005ea5478b85f6c730c56c2606edff07949ad6823f1f00000000001600140345e587cb42c201c30e505ea9f6f5fb935876acbcb81b000000000016001472fb714ecb210311655a3da22729ff8626bdea59608c160000000000160014a2d379dbb47a38c9839e9e3a2df292e6255c5d3a1a8815000000000016001465c924de97963d4209528a613d627a5bc72397ed723414000000000017a914278dadd16d1314122e4dde67ff9152a61c3a9f478774831300000000001600148826b6c481b029409c931f8df786c092ccf21469456f130000000000160014e8dc41c47939430293f45747ea47e3325a536ec6511d13000000000017a9147a6d8577087d78c261d9d292ea838c9c623ea71c87e24112000000000022002061a2b0a1d72c46828464e83fd2bd986619691a544ca1b7dea6d7b9f5d4259010273f120000000000160014dd8f9b751054ab03f19ba0d36bf8ca50595e7466b1f3110000000000160014542296c4e9ed1fd643e3b1ddb7ff0022acfd781d8fb3110000000000160014f67490875247efb7314b26d1f0f331b75bb4df65b09f11000000000016001420173973b42d0d9334bd92ca231b65665fb3cb0ef8c11000000000002251202505b1ae10be41185da7c0561fd3f4dc56630e9d49264429046777a778f0ab7e1db7100000000000160014b7e81bc54daaad630b3d8da1c20418ce0aa157ad3b8c100000000000220020b0cb7174384edc43c645a0a44ffbb70d8ecf5d0d9912fc819e2970f89af38f5d3e73100000000000160014f6848b0a9c8408abfe956345e9b1e02eacbe9d58315f100000000000160014c5f79480fc5417e2ba5762e89fbf357828d2c2a0b25b10000000000017a9149f31679a6a7d7c22668bb467ac490e950d74dbdb87a64a1000000000001600141945bdbff512289c7cdcfd7158142f23abe4ea52853810000000000017a91468750c2ae538b335f5ebdcdc95b42b148ebce51487d71d100000000000160014b5f7ede18ab02fd488f21387ed4c93d9746d2eb2821b10000000000017a914e41c245e9565123b7441a2532bb58143d6a71bf687b40810000000000022002087a0ae628cc3a8af31ce2132e4cd85e25aa965642560a0e6c9d410507d422b3274c075010000000017a914413b5901fe4e591c95405fd446b5b002da575bf0870000000000000000266a24aa21a9edb1a2db0eeaa343388018b6c539bdb0944f563a5d5c8d9c231d20dbba88ed0da200000000)
    ;; block id: 00000000000000000001cd83ba4ebc179970c571c67cf680f931ad57f392af93 
    (raw-block-header 0x000000289ae31c64a91ed66c9e10338273dbc6fb85718973060c01000000000000000000ec632cf19fcf973835da9999ca8237bb85ce194b20332b1b32e188290284348385891868ed5c0217997b9d99)
    (witness-merkle-root 0xc585ca76300bd5d5754ac8df404d6cdf2d416032f951843632fcb4b2bd803249)
    (witness-reserved-data 0x0000000000000000000000000000000000000000000000000000000000000000)
    (parsed-block-header (contract-call? .clarity-bitcoin parse-block-header raw-block-header))
    (parsed-tx (contract-call? .clarity-bitcoin parse-wtx raw-tx false))
  )
    (let ((result (contract-call? .clarity-bitcoin was-segwit-tx-mined-compact
      burnchain-block-height
      raw-tx
      raw-block-header
      u3
      u13
      (list 0x96f1d1a57419cb75e7a1a44f0d54c8d3efc0f3a912607f7ee8d1a860ac5ebe27 
    0x66698348a86bfdcc762210686a35d2b5de70e73adbc304b60cfd7787f470ea13 
    0xa9df9b7587d394b3193a8ae65ee73ea5b06b1bf8da7e598b8aa8b615a2a30b9a 
    0x03a9d03dc7316baca073e21a74d6c55554c31a7b48cb81be1418f9315d310c7a 
    0xf4904cc9abdef33b5e14b7fffb966afffadbc8486672d31a775271a8a8a20ab7 
    0xb0e0e12fdb9557926f194ddf4da8315a76e47f19a88f2d166e5467c476a832fd 
    0x4cf4da4d65a7e48ac813344dcc0440cf4ad283dfb77ce066ad1a2fd3abfb3e64 
    0x07e6353a809716851c5f99b3e7f15183b67f2b94d849785d592b04031624ca5d 
    0xc46ea45f876bb3d2b404a41bb964b87ff8ac7307928f2d7c783c55dda23d0522 
    0x19bf7ca9276063e9880fb6969fc61dab7edbe861ed18826294aa520880824919 
    0x19e48a64d60a7293149a5933ecf370ffaa462cd6c39bd60c9e27639e994e7ed4 
    0xafbcda0aa3df1c4b24d05ce8fbce41f025cf0c887f5c1025bb74f6e34fa477d6 
    0x102364c7305152af68c7dec80752487b1746fbb4d7dc37b512476f9d4ffb2b54)
      witness-merkle-root
      witness-reserved-data
      raw-coinbase-tx
      (list 0x6f9dd42f32a45fb2208862699a8a3a55f22400e890f51d6759974918793d01ed
   0xe4f2928f30571a9a8e4f61715564c404416d61f12e7c2e5bcd0bde0eeb332b07
   0xc907ef913f71deb472ee69c73a0edc9519461476bec03f9667990acfe4a35bef
   0x91501e6db3906f99b25731579e04a027f676c95de322c353dd0bab2101b6e496
   0x8d0bc08d1a79a283f6d05f6b255e91e721b0bf285b45d7a12c4a15eba75dcc1e
   0xbaab3de115a6262645ed80c65116e9c8d45c3371134c80d4c05562a4d18b8c01
   0x711d45e4727f24ce65342d617c1256c50be0d77472d32bee4a6a7d298894395c
   0x0ad964110d3174605b4a55e13a181bdc68eaa6279f00c00375ae61bce4165fb7
   0x95b1d6f58fd463f2b978db1db3c14672676c2ced1a7b17fc0fa43d9b19f53d41
   0x4014fc658167fe3f222ff71a5600b2be1b21f0088b1350e3d7227f4376a2e933
   0xe27b7eb76fe79487b84213ecf44ba02094de7ed59b38d2bf0e85283ea339944f
   0xa0149080154b3f24992cac558875344b6b72eca71fd8231c93709d325995e15e
   0x3773030efef201607073b272df4eb43ebef20e26cd27b25312a0ee8658760b73)
    )))
    (asserts! (is-eq result (ok 0x76daca791cbd062eed90bbb992478f6d700b990698d5f08dcca650729bedd605)) (err "expected txid"))
    (ok true))
  )
)

;; @name verify segwit transaction with left over data
(define-public (test-parse-wtx)
  (let (
    (burnchain-block-height u2431087)
    ;; txid: 3b3a7a31c949048fabf759e670a55ffd5b9472a12e748b684db5d264b6852084
    (raw-tx 0x0200000000010218f905443202116524547142bd55b69335dfc4e4c66ff3afaaaab6267b557c4b030000000000000000e0dbdf1039321ab7a2626ca5458e766c6107690b1a1923e075c4f691cc4928ac0000000000000000000220a10700000000002200208730dbfaa29c49f00312812aa12a62335113909711deb8da5ecedd14688188363c5f26010000000022512036f4ff452cb82e505436e73d0a8b630041b71e037e5997290ba1fe0ae7f4d8d50140a50417be5a056f63e052294cb20643f83038d5cd90e2f90c1ad3f80180026cb99d78cd4480fadbbc5b9cad5fb2248828fb21549e7cb3f7dbd7aefd2d541bd34f0140acde555b7689eae41d5ccf872bb32a270893bdaa1defc828b76c282f6c87fc387d7d4343c5f7288cfd9aa5da0765c7740ca97e44a0205a1abafa279b530d5fe36d182500ffffff)
    ;; block id: 000000000000000606f86a5bc8fb6e38b16050fb4676dea26cba5222583c4d86
  )
    (let ((result (contract-call? .clarity-bitcoin parse-wtx raw-tx false)))
    (asserts! (is-eq result (err ERR-LEFTOVER-DATA)) (err "expected ERR-LEFTOVER-DATA"))
    (ok true))
  )
)

;; @name parse-wtx is unable to parse a non-segwit transaction (returns unpredictable values)
(define-public (test-parse-wtx-on-non-segwit-1)
  (let (
    (segwit-tx 0x020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff03016500ffffffff0200f2052a010000002251205444612a122cd09b4b3457d46c149a23d8685fb7d3aac61ea7eee8449555293b0000000000000000266a24aa21a9edab124e70e4a18e72f2ac6f635aebb08862d5b5b1c0519cd9f3222a24a48482560120000000000000000000000000000000000000000000000000000000000000000000000000)
    (non-segwit-tx 0x02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff2503831a250000000000000000000000000000000002000000000000073c7500000000000000ffffffff02be402500000000001976a91455a2e914aeb9729b4cd265248cb67a865eae95fd88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf900000000)
    (parsed-tx-with-segwit-function (contract-call? .clarity-bitcoin parse-wtx non-segwit-tx false))
    (parsed-tx-with-non-segwit-function (contract-call? .clarity-bitcoin parse-tx non-segwit-tx))
    (correct-parsed-tx { ins: (list { outpoint: { hash: 0x0000000000000000000000000000000000000000000000000000000000000000, index: u4294967295 }, scriptSig: 0x03831a250000000000000000000000000000000002000000000000073c7500000000000000, sequence: u4294967295 }), locktime: u0, outs: (list { scriptPubKey: 0x76a91455a2e914aeb9729b4cd265248cb67a865eae95fd88ac, value: u2441406 }  { scriptPubKey: 0x6a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf9, value: u0 }), version: u2 })
    ;;(wrong-parsed-tx { ins: (list), locktime: u0, outs: (list), segwit-marker: u1, segwit-version: u0, version: u2, witnesses: (list) })
  )
    (ok
      (asserts!
        (and
          (is-eq parsed-tx-with-segwit-function (err ERR-NOT-SEGWIT-TRANSACTION))
          (is-eq parsed-tx-with-non-segwit-function (ok correct-parsed-tx))
        )
      (err u1)))
  )
)


(define-constant ERR-OUT-OF-BOUNDS u1)
(define-constant ERR-TOO-MANY-TXINS u2)
(define-constant ERR-TOO-MANY-TXOUTS u3)
(define-constant ERR-VARSLICE-TOO-LONG u4)
(define-constant ERR-BAD-HEADER u5)
(define-constant ERR-HEADER-HEIGHT-MISMATCH u6)
(define-constant ERR-INVALID-MERKLE-PROOF u7)
(define-constant ERR-PROOF-TOO-SHORT u8)
(define-constant ERR-TOO-MANY-WITNESSES u9)
(define-constant ERR-INVALID-COMMITMENT u10)
(define-constant ERR-WITNESS-TX-NOT-IN-COMMITMENT u11)
(define-constant ERR-NOT-SEGWIT-TRANSACTION u12)
(define-constant ERR-LEFTOVER-DATA u13)
